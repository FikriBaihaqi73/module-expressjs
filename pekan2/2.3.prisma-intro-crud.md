# Pekan 2 - Hari 9: Pengenalan Prisma ORM & CRUD (MVC + Modular Schema)

**HARI KE-9** – Menghubungkan Express dengan Database
**Fokus hari ini:** Meninggalkan query SQL manual, beralih ke Prisma ORM yang modern, dan mengelola schema database yang rapi dengan fitur **Prisma Schema Folder**.

---

## 1. Apa itu Prisma ORM?

**ORM (Object-Relational Mapping)** adalah jembatan antara kode kita (JavaScript/TypeScript) dengan database (SQL).
Tanpa ORM: Kita tulis `SELECT * FROM users` (String rawan typo).
Dengan Prisma: Kita tulis `prisma.user.findMany()` (Autocompletion, Type-safe!).

**Kenapa Prisma?**
- **Type-safe:** Terintegrasi sempurna dengan TypeScript.
- **Readable:** Syntax sangat mudah dibaca manusia.
- **Auto-migration:** Mengurus perubahan struktur database dengan mudah.

---

## 2. Konsep Modularisasi: Prisma Schema Folder

Secara default, Prisma menggunakan satu file besar `schema.prisma`. Untuk project kecil, ini oke. Tapi untuk project besar, kita perlu memecahnya.

**Solusi: Prisma Schema Folder**
Fitur ini memungkinkan kita memecah schema menjadi banyak file kecil di dalam folder `prisma/schema/`.
Contoh struktur:
```
prisma/
└── schema/
|    └── product.prisma (Model Product)
|    └── user.prisma (Model User)
├──── schema.prisma    (Config Generator & Datasource)
```

---

## 3. Setup Prisma di Project Express

Lanjutkan project `e-commerce-api` dari Pekan 1.

### A. Install Dependency
```bash
npm install prisma --save-dev
npm install @prisma/client
```

### B. Inisialisasi Prisma
```bash
npx prisma init
```
Ini akan membuat folder `prisma/` dan file `.env`.

### C. Konfigurasi Database (.env)
Edit file `.env`, sesuaikan URL database PostgreSQL kamu.
```env
DATABASE_URL="postgresql://user:password@localhost:5432/ecommerce_db?schema=public"
```

### D. Mengaktifkan Prisma Schema Folder

1.  **Buat folder** `prisma/schema`.
2.  **Pindahkan** file `prisma/schema.prisma` ke dalam folder `prisma/schema/`.
3.  **Ubah isinya** (bisa direname jadi `schema.prisma` atau tetap `schema.prisma`) untuk mengaktifkan fitur `prismaSchemaFolder`:

```prisma
// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["prismaSchemaFolder"] // WAJIB: Aktifkan fitur ini
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

4.  **Buat file model produk** `prisma/schema/product.prisma`:

```prisma
// prisma/schema/product.prisma

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  // Optional
  price       Decimal  @db.Decimal(10, 2)
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}
```

### E. Migrasi (Sync ke Database)
Prisma akan otomatis menggabungkan semua file dalam `prisma/schema/`.
```bash
npx prisma migrate dev --name init_products
```

---

## 4. Implementasi Prisma di Arsitektur MVC (Functional Style)

Kita akan menggunakan **Functional Service Pattern** (bukan Class/OOP) agar kode lebih simpel dan *to-the-point*.

### Langkah 1: Buat Prisma Client Instance
Buat file `src/prisma.ts`.

```ts
// src/prisma.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export default prisma;
```

### Langkah 2: Update Service Layer (Functional)
Buka `src/services/product.service.ts`. Gunakan `export const` untuk setiap fungsi.

```ts
// src/services/product.service.ts
import prisma from '../prisma';
import { Product } from '@prisma/client';

export const getAllProducts = async (): Promise<Product[]> => {
  return await prisma.product.findMany();
};

export const getProductById = async (id: number): Promise<Product> => {
  const product = await prisma.product.findUnique({
    where: { id },
  });
  
  if (!product) {
    throw new Error('Product not found');
  }
  
  return product;
};

export const createProduct = async (data: { 
  name: string; 
  description?: string; 
  price: number; 
  stock: number 
}): Promise<Product> => {
  return await prisma.product.create({
    data: {
      name: data.name,
      description: data.description,
      price: data.price,
      stock: data.stock,
    },
  });
};

export const updateProduct = async (id: number, data: Partial<Product>): Promise<Product> => {
  await getProductById(id); // Cek existance

  return await prisma.product.update({
    where: { id },
    data,
  });
};

export const deleteProduct = async (id: number): Promise<Product> => {
  await getProductById(id); // Cek existance

  return await prisma.product.delete({
    where: { id },
  });
};
```

### Langkah 3: Update Controller
Panggil fungsi service secara langsung.

```ts
// src/controllers/product.controller.ts
import { Request, Response } from 'express';
import * as productService from '../services/product.service'; // Import semua fungsi
import { asyncHandler } from '../utils/async.handler';
import { successResponse } from '../utils/response';

export const index = asyncHandler(async (req: Request, res: Response) => {
  const products = await productService.getAllProducts();
  return successResponse(res, 'List Products', products);
});

export const create = asyncHandler(async (req: Request, res: Response) => {
  const product = await productService.createProduct({
    ...req.body,
    price: Number(req.body.price),
    stock: Number(req.body.stock)
  });
  return successResponse(res, 'Product created', product, null, 201);
});

export const show = asyncHandler(async (req: Request, res: Response) => {
  const id = Number(req.params.id);
  const product = await productService.getProductById(id);
  return successResponse(res, 'Product detail', product);
});

// ... implementasi update & delete serupa
```

---

## 5. Tugas Harian Hari Ke-9

**Misi:** Migrasi Full ke Database dengan Prisma & MVC (Functional).

1.  **Setup Modular Schema:** Pindahkan `schema.prisma` ke `prisma/schema/` dan aktifkan `prismaSchemaFolder`.
2.  **Refactor Service:** Ubah `product.service.ts` menjadi kumpulan fungsi (Functional Pattern).
3.  **Refactor Controller:** Panggil fungsi service tersebut.
4.  **Test:** CRUD via Postman.

**Checklist:**
- [ ] Folder `prisma/schema/` berisi `schema.prisma` dan `product.prisma`.
- [ ] `npx prisma migrate dev` sukses.
- [ ] Service menggunakan `export const` (bukan Class).
- [ ] CRUD berjalan normal.

---

**Selamat!** Kamu sudah menerapkan standar industri yang modern dan rapi!
