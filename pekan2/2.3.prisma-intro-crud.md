# Pekan 2 - Hari 9: Pengenalan Prisma ORM & CRUD

**HARI KE-9** â€“ Menghubungkan Express dengan Database
**Fokus hari ini:** Meninggalkan query SQL manual, beralih ke Prisma ORM yang modern dan Type-safe.

---

## 1. Apa itu Prisma ORM?

**ORM (Object-Relational Mapping)** adalah jembatan antara kode kita (JavaScript/TypeScript) dengan database (SQL).
Tanpa ORM: Kita tulis `SELECT * FROM users` (String rawan typo).
Dengan Prisma: Kita tulis `prisma.user.findMany()` (Autocompletion, Type-safe!).

**Kenapa Prisma?**
- **Type-safe:** Terintegrasi sempurna dengan TypeScript.
- **Readable:** Syntax sangat mudah dibaca manusia.
- **Auto-migration:** Mengurus perubahan struktur database dengan mudah.

---

## 2. Setup Prisma di Project Express

Lanjutkan project `e-commerce-api` dari Pekan 1.

### A. Install Dependency
```bash
npm install prisma --save-dev
npm install @prisma/client
```

### B. Inisialisasi Prisma
```bash
npx prisma init
```
Ini akan membuat folder `prisma/` dan file `.env`.

### C. Konfigurasi Database (.env)
Edit file `.env`, sesuaikan URL database PostgreSQL kamu:
```env
DATABASE_URL="postgresql://user:password@localhost:5432/ecommerce_db?schema=public"
```
*(Ganti user, password, dan nama db sesuai setup PostgreSQL kamu di Hari 7)*

### D. Membuat Model (prisma/schema.prisma)
Definisikan tabel kita dalam bentuk model Prisma.

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  // Tanda tanya artinya Boleh NULL (Optional)
  price       Decimal  @db.Decimal(10, 2) // Tipe data khusus decimal
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

### E. Migrasi (Sync ke Database)
Perintah ini akan membuat tabel di database PostgreSQL sesuai model di atas.
```bash
npx prisma migrate dev --name init_products
```

---

## 3. Menggunakan Prisma Client (CRUD)

Buat file `src/prisma.ts` agar client bisa dipakai ulang (Singleton pattern sederhana).
```ts
// src/prisma.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export default prisma;
```

Sekarang update `src/index.ts` (atau controller kamu) untuk pakai Prisma.

### READ (Get All)
```ts
import prisma from './prisma';

app.get('/api/products', async (req, res) => {
  const products = await prisma.product.findMany();
  res.json({ data: products });
});
```

### CREATE (Post)
```ts
app.post('/api/products', async (req, res) => {
  const { name, description, price, stock } = req.body;
  
  const product = await prisma.product.create({
    data: {
      name,
      description,
      price: Number(price), // Pastikan number
      stock: Number(stock)
    }
  });

  res.status(201).json({ data: product });
});
```

### READ ONE (Get by ID)
```ts
app.get('/api/products/:id', async (req, res) => {
  const { id } = req.params;
  
  const product = await prisma.product.findUnique({
    where: { id: Number(id) }
  });

  if (!product) return res.status(404).json({ message: "Not found" });
  
  res.json({ data: product });
});
```

### UPDATE (Put)
```ts
app.put('/api/products/:id', async (req, res) => {
  const { id } = req.params;
  const { name, price } = req.body;

  try {
    const product = await prisma.product.update({
      where: { id: Number(id) },
      data: { name, price: Number(price) }
    });
    res.json({ data: product });
  } catch (error) {
    res.status(404).json({ message: "Product not found" });
  }
});
```

### DELETE
```ts
app.delete('/api/products/:id', async (req, res) => {
  const { id } = req.params;

  try {
    await prisma.product.delete({
      where: { id: Number(id) }
    });
    res.json({ message: "Deleted successfully" });
  } catch (error) {
    res.status(404).json({ message: "Product not found" });
  }
});
```

---

## 4. Tugas Harian Hari Ke-9

**Misi:** Ubah API E-Commerce "Array Memory" kamu menjadi "Real Database" dengan Prisma.

1.  **Setup Prisma:** Lakukan langkah instalasi dan config.
2.  **Schema:** Buat model `Product` seperti contoh.
3.  **Refactor:** Ganti semua logic di `src/index.ts` yang tadinya pakai variable `let products = []` menjadi `prisma.product...`.
4.  **Test:** Coba CRUD pakai Postman. Data harus tersimpan permanen di PostgreSQL (cek pakai DBeaver/psql).

**Checklist:**
- [ ] `npx prisma migrate dev` sukses.
- [ ] Tabel `Product` muncul di database.
- [ ] Endpoint GET, POST, PUT, DELETE berfungsi normal.
- [ ] Data tidak hilang saat server direstart.

---

**Selamat!** Kamu sudah resmi menjadi Backend Developer yang bisa mengelola Database sungguhan. ðŸŽ‰
