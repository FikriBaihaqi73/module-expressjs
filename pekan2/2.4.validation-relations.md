# Pekan 2 - Hari 10: Validasi & Relasi 1-N dengan Prisma

**HARI KE-10** ‚Äì Menjaga Kualitas Data & Menghubungkan Model
**Fokus hari ini:** Validasi input agar data tidak sampah, dan membuat relasi Kategori Produk.

---

## 1. Validasi Input (Express-Validator / Zod)

Jangan pernah percaya input dari user! User bisa mengirim data kosong, format salah, atau berbahaya.

Kita akan gunakan `express-validator` (atau `zod` jika preferensi modern). Di sini kita pakai `express-validator` dulu karena populer di Express.

### Install
```bash
npm install express-validator
```

> [!NOTE]
> **Zod vs Express-Validator**
> Di industri modern, library bernama **Zod** sedang naik daun karena integrasi TypeScript-nya yang luar biasa. Namun, `express-validator` masih sangat populer dan mudah dipelajari untuk pemula. Kita akan pakai `express-validator` dulu.

### Contoh Penggunaan di Route
```ts
import { body, validationResult } from 'express-validator';

app.post('/api/products', [
  // Rules Validasi
  body('name').notEmpty().withMessage('Nama produk wajib diisi'),
  body('price').isNumeric().withMessage('Harga harus angka').custom(value => value > 0),
  body('stock').isInt({ min: 0 }).withMessage('Stok tidak boleh minus'),
], async (req, res) => {
  
  // Cek Error
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    // Return 400 Bad Request dengan detail error
    return res.status(400).json({ 
      success: false,
      message: "Validasi Gagal",
      errors: errors.array() 
    });
  }

  // Lanjut proses simpan ke DB...
});
```

---

## 2. Relasi One-to-Many di Prisma

Kita ingin 1 Produk memiliki 1 Kategori. 1 Kategori bisa punya Banyak Produk.

### Update Schema (`prisma/schema.prisma`)

```prisma
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[] // Relasi balik (1 kategori punya banyak produk)
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  price       Decimal
  categoryId  Int?     // Foreign Key (Boleh null dulu biar gampang migrasi)
  category    Category? @relation(fields: [categoryId], references: [id])
}
```

### Migrasi Ulang
```bash
npx prisma migrate dev --name add_category_relation
```

---

## 3. CRUD dengan Relasi (Nested Write & Include)

### Create Category
```ts
app.post('/api/categories', async (req, res) => {
  const category = await prisma.category.create({
    data: { name: req.body.name }
  });
  res.json(category);
});
```

### Create Product dengan Category
User mengirim `categoryId` di body.
```ts
app.post('/api/products', async (req, res) => {
  const { name, price, categoryId } = req.body;
  
  const product = await prisma.product.create({
    data: {
      name,
      price,
      categoryId: Number(categoryId) // Hubungkan ke kategori
    }
  });
  res.json(product);
});
```

### Read Product BESERTA Category (Include)
Kalau cuma `findMany()`, data kategori tidak muncul. Kita harus pakai `include`.
```ts
app.get('/api/products', async (req, res) => {
  const products = await prisma.product.findMany({
    include: {
      category: true // Sertakan data kategori
    }
  });
  res.json(products);
});
```
*Hasil JSON nanti ada object `category` di dalam setiap product.*

---

## 4. Tugas Harian Hari Ke-10

**Misi:** Tambahkan fitur Kategori dan Validasi di API E-Commerce kamu.

1.  **Validasi:**
    - Tambahkan validasi di POST /products dan PUT /products.
    - Pastikan nama tidak kosong, harga > 0.
2.  **Relasi:**
    - Buat model `Category`.
    - Hubungkan `Product` ke `Category`.
    - Buat CRUD untuk `/api/categories`.
3.  **Integrasi:**
    - Saat create product, user wajib/bisa memilih `categoryId`.
    - Saat get product, tampilkan juga nama kategorinya.

**Checklist:**
- [ ] Validasi berjalan (coba kirim data kosong, harus error 400).
- [ ] Tabel Category terbentuk.
- [ ] Bisa tambah kategori baru.
- [ ] Produk terhubung ke kategori.
- [ ] Endpoint GET products menampilkan detail kategori.

---

**Tips:** Validasi adalah garda terdepan keamanan aplikasi. Relasi adalah kunci struktur data yang baik. üõ°Ô∏è

---

## 5. Kuis Pilihan Ganda (Latihan)

1. **Mengapa kita perlu melakukan validasi input?**
   a. Agar database penuh
   b. Mencegah data sampah atau berbahaya masuk ke sistem
   c. Agar user bingung
   d. Supaya aplikasi berjalan lambat

2. **Library populer untuk validasi di Express.js adalah...**
   a. `express-check`
   b. `express-validator`
   c. `express-secure`
   d. `express-guard`

3. **HTTP Status Code yang tepat jika validasi gagal adalah...**
   a. 200 OK
   b. 500 Internal Server Error
   c. 400 Bad Request
   d. 404 Not Found

4. **Dalam Prisma, relasi One-to-Many didefinisikan dengan...**
   a. Array di satu sisi (contoh: `Product[]`) dan field relation di sisi lain
   b. Array di kedua sisi
   c. Tidak perlu didefinisikan
   d. Menggunakan JSON

5. **Apa fungsi `include` saat melakukan query `findMany`?**
   a. Memfilter data
   b. Mengurutkan data
   c. Mengambil data relasi (join) agar ikut muncul di response
   d. Menghapus data relasi

6. **Jika `Product` punya `categoryId`, maka `categoryId` disebut sebagai...**
   a. Primary Key
   b. Foreign Key
   c. Candidate Key
   d. Super Key

7. **Apa arti `@relation(fields: [categoryId], references: [id])` di schema Prisma?**
   a. Membuat tabel baru
   b. Menghapus kolom categoryId
   c. Mendefinisikan hubungan Foreign Key antara kolom `categoryId` di tabel ini dengan `id` di tabel referensi
   d. Membuat index pencarian

8. **Manakah format JSON response error validasi yang baik?**
   a. `<html>Error</html>`
   b. `{"message": "Error"}`
   c. `{"success": false, "errors": [...]}`
   d. Kosong saja

9. **Kapan validasi sebaiknya dilakukan?**
   a. Setelah data masuk database
   b. Sebelum data diproses atau disimpan ke database
   c. Saat user logout
   d. Tidak perlu validasi

10. **Library validasi modern yang sangat Type-safe dan sering dipasangkan dengan TypeScript adalah...**
    a. Joi
    b. Zod
    c. Yup
    d. Validator.js

11. **Apa nama file konfigurasi utama untuk setup Prisma yang kustom (seperti mengatur path schema)?**
    a. `prisma/schema.prisma`
    b. `prisma.config.ts`
    c. `src/config/database.js`
    d. `package.json`

12. **Berdasarkan konfigurasi `prisma.config.ts`, di mana lokasi file schema model disimpan?**
    a. `prisma/`
    b. `src/models/`
    c. `src/prisma/schema/`
    d. `database/schema/`

13. **File apa yang menjadi entry point definisi schema di `prisma.config.ts`?**
    a. `src/prisma/schema/base.prisma`
    b. `src/prisma/schema.prisma`
    c. `prisma/schema.prisma`
    d. `index.ts`

14. **Bagaimana cara mendefinisikan fungsi service?**
    a. `public getAllProducts() {}`
    b. `static async getAllProducts() {}`
    c. `export const getAllProducts = async () => {}`
    d. `function getAllProducts() {}` (di dalam class)

16. **Di mana lokasi file migrasi disimpan sesuai konfigurasi `prisma.config.ts` kita?**
    a. `prisma/migrations`
    b. `src/prisma/migrations`
    c. `migrations/`
    d. `database/migrations`

17. **Jika ingin membuat model baru `Transaction`, apa yang harus dilakukan?**
    a. Edit `src/prisma/schema.prisma` langsung
    b. Buat file baru `src/prisma/schema/Transaction.prisma`
    c. Buat file `src/models/Transaction.ts`
    d. Jalankan query SQL manual

18. **Bagaimana cara mengimport semua fungsi dari `product.service.ts` ke controller?**
    a. `import ProductService from '../services/product.service'`
    b. `import { getAll } from '../services/product.service'`
    c. `import * as productService from '../services/product.service'`
    d. `require('../services/product.service')`

19. **Dari mana `prisma.config.ts` mengambil URL database?**
    a. Hardcoded string
    b. File `src/config/database.js` (yang load .env)
    c. Langsung dari `process.env`
    d. Dari file `package.json`

20. **Mengapa kita memecah schema menjadi banyak file (Modular Schema)?**
    a. Agar terlihat keren
    b. Agar file `schema.prisma` tidak terlalu panjang dan lebih mudah di-maintain
    c. Agar Prisma bingung
    d. Karena wajib dari Prisma
