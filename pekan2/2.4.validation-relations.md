# Pekan 2 - Hari 10: Validasi & Relasi 1-N dengan Prisma

**HARI KE-10** â€“ Menjaga Kualitas Data & Menghubungkan Model
**Fokus hari ini:** Refactoring Validasi ke Utils & Middleware, serta Implementasi Relasi Kategori Produk.

---

## 1. Refactoring Validasi (Pemisahan Logic & Rules)

Agar kode lebih bersih dan *reusable*, kita pisahkan logika validasi (`validate` helper) dari aturan validasi (`rules`).

### A. Buat Helper Validasi (`src/utils/validate.ts`)
File ini berisi fungsi generic untuk menjalankan validasi `express-validator` dan mengembalikan response error yang seragam.

```ts
import { validationResult, type ValidationChain } from 'express-validator';
import type { Request, Response, NextFunction } from 'express';
import { errorResponse } from './response';

export const validate = (validations: ValidationChain[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    // Jalankan semua rules validasi secara paralel
    await Promise.all(validations.map(validation => validation.run(req)));

    const errors = validationResult(req);
    if (errors.isEmpty()) {
      return next(); // Lanjut ke controller jika tidak ada error
    }

    // Format error agar rapi
    const errorList = errors.array().map((err: any) => ({
      field: err.path || err.param || 'unknown',
      message: err.msg
    }));

    // Return response error 400
    return errorResponse(res, 'Validasi gagal', 400, errorList);
  };
};
```

### B. Buat Rules Validasi (`src/middlewares/product.validation.ts`)
Di sini kita HANYA mendefinisikan aturannya saja. Import `validate` helper-nya nanti di Router, bukan di sini (untuk menghindari circular dependency atau struktur yang membingungkan).

```ts
import { body, param } from 'express-validator';

// Rules untuk Create Product
export const createProductValidation = [
  body('name')
    .trim()
    .notEmpty().withMessage('Nama produk wajib diisi')
    .isLength({ min: 3 }).withMessage('Nama produk minimal 3 karakter'),
  
  body('price')
    .notEmpty().withMessage('Harga wajib diisi')
    .isNumeric().withMessage('Harga harus angka')
    .custom((value: number) => value > 0).withMessage('Harga harus lebih dari 0'),
    
  // ... rules lain (stock, description, dll)
];

// Rules untuk Get By ID
export const getProductByIdValidation = [
  param('id')
    .isNumeric().withMessage('ID harus angka')
];
```

### C. Pasang di Router (`src/routes/product.route.ts`)
Gabungkan helper `validate` dengan rules yang sudah dibuat.

```ts
import { Router } from 'express';
import { createProduct, ... } from '../controllers/product.controller';
import { validate } from '../utils/validate'; // Import helper
import { createProductValidation } from '../middlewares/product.validation'; // Import rules

const router = Router();

// Pasang middleware validate() sebelum controller
router.post('/products', validate(createProductValidation), createProduct);

export default router;
```

---

## 2. Relasi One-to-Many di Prisma (Product & Category)

Kita ingin 1 Produk memiliki 1 Kategori. 1 Kategori bisa punya Banyak Produk.

### A. Update Schema (Support Multiple Files)
Project kita menggunakan struktur **Multiple Schema Files** (Fitur Prisma v7+). Kita tidak menumpuk semua model di satu file, tapi memisahnya ke dalam folder `src/prisma/schema/*.prisma`.

**1. Buat file baru `src/prisma/schema/Category.prisma`:**
```prisma
model Category {
  id        Int       @id @default(autoincrement())
  name      String    @unique
  products  Product[] // Relasi balik: 1 Kategori -> Banyak Produk
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("categories")
}
```

**2. Update file `src/prisma/schema/Product.prisma`:**
Tambahkan field relasi ke `Category`.

```prisma
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  stock       Int      @default(0)
  
  // === TAMBAHAN RELASI ===
  categoryId  Int?     // Foreign Key
  category    Category? @relation(fields: [categoryId], references: [id])
  // =======================

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}
```

### B. Migrasi Database
```bash
npx prisma migrate dev --name add_category_relation
```

---

## 3. Implementasi Kategori (MVC Pattern)

Buat fitur kategori lengkap dengan struktur MVC yang sudah kita pelajari.

### A. Service (`src/services/category.service.ts`)
```ts
import prisma from '../prisma';

export const getAllCategories = async () => {
  return await prisma.category.findMany();
};

export const createCategory = async (name: string) => {
  return await prisma.category.create({
    data: { name }
  });
};
```

### B. Controller (`src/controllers/category.controller.ts`)
Gunakan `asyncHandler` dan `successResponse` seperti biasa.
```ts
import { Request, Response } from 'express';
import * as CategoryService from '../services/category.service';
import { asyncHandler } from '../utils/async.handler';
import { successResponse } from '../utils/response';

export const listCategories = asyncHandler(async (req: Request, res: Response) => {
  const categories = await CategoryService.getAllCategories();
  return successResponse(res, 'Daftar Kategori', categories);
});

export const addCategory = asyncHandler(async (req: Request, res: Response) => {
  // Asumsi req.body.name sudah divalidasi
  const category = await CategoryService.createCategory(req.body.name);
  return successResponse(res, 'Kategori berhasil dibuat', category, null, 201);
});
```

### C. Route (`src/routes/category.route.ts`)
```ts
import { Router } from 'express';
import { listCategories, addCategory } from '../controllers/category.controller';
// Jangan lupa buat validasi untuk kategori juga!

const router = Router();

router.get('/categories', listCategories);
router.post('/categories', addCategory);

export default router;
```

---

## 4. Update Product untuk Support Relasi

### A. Update Product Service (`src/services/product.service.ts`)
Update `createProduct` untuk menerima `categoryId`.

```ts
export const createProduct = async (data: { 
  name: string; 
  price: number; 
  stock: number;
  description?: string;
  categoryId?: number; // Tambahan field
}) => {
  return await prisma.product.create({
    data: {
      name: data.name,
      price: data.price,
      stock: data.stock,
      description: data.description,
      categoryId: data.categoryId // Prisma akan otomatis handle foreign key
    },
  });
};
```

### B. Update Read Product dengan `include`
Agar saat GET product, data kategorinya ikut muncul.

```ts
export const getAllProducts = async () => {
  return await prisma.product.findMany({
    include: {
      category: true // Sertakan data kategori
    }
  });
};
```

---

## 5. Tugas Harian Hari Ke-10

**Misi:** Refactor kode validasi & Tambahkan fitur Kategori di API E-Commerce.

1.  **Refactor Validasi:**
    - Pindahkan fungsi `validate` ke `src/utils/validate.ts`.
    - Pindahkan rules ke `src/middlewares/*.validation.ts`.
    - Terapkan di route product.
2.  **Relasi Kategori:**
    - Update `schema.prisma` & migrate.
    - Buat module Category (Service, Controller, Route).
    - Hubungkan Product dengan Category (saat Create & Get).
3.  **Integrasi:**
    - Pastikan saat `POST /products`, user bisa kirim `categoryId`.
    - Pastikan saat `GET /products`, muncul object `category`.


## 5. Kuis Pilihan Ganda (Latihan)

1. **Mengapa kita perlu melakukan validasi input?**
   a. Agar database penuh
   b. Mencegah data sampah atau berbahaya masuk ke sistem
   c. Agar user bingung
   d. Supaya aplikasi berjalan lambat

2. **Library populer untuk validasi di Express.js adalah...**
   a. `express-check`
   b. `express-validator`
   c. `express-secure`
   d. `express-guard`

3. **HTTP Status Code yang tepat jika validasi gagal adalah...**
   a. 200 OK
   b. 500 Internal Server Error
   c. 400 Bad Request
   d. 404 Not Found

4. **Dalam Prisma, relasi One-to-Many didefinisikan dengan...**
   a. Array di satu sisi (contoh: `Product[]`) dan field relation di sisi lain
   b. Array di kedua sisi
   c. Tidak perlu didefinisikan
   d. Menggunakan JSON

5. **Apa fungsi `include` saat melakukan query `findMany`?**
   a. Memfilter data
   b. Mengurutkan data
   c. Mengambil data relasi (join) agar ikut muncul di response
   d. Menghapus data relasi

6. **Jika `Product` punya `categoryId`, maka `categoryId` disebut sebagai...**
   a. Primary Key
   b. Foreign Key
   c. Candidate Key
   d. Super Key

7. **Apa arti `@relation(fields: [categoryId], references: [id])` di schema Prisma?**
   a. Membuat tabel baru
   b. Menghapus kolom categoryId
   c. Mendefinisikan hubungan Foreign Key antara kolom `categoryId` di tabel ini dengan `id` di tabel referensi
   d. Membuat index pencarian

8. **Manakah format JSON response error validasi yang baik?**
   a. `<html>Error</html>`
   b. `{"message": "Error"}`
   c. `{"success": false, "errors": [...]}`
   d. Kosong saja

9. **Kapan validasi sebaiknya dilakukan?**
   a. Setelah data masuk database
   b. Sebelum data diproses atau disimpan ke database
   c. Saat user logout
   d. Tidak perlu validasi

10. **Library validasi modern yang sangat Type-safe dan sering dipasangkan dengan TypeScript adalah...**
    a. Joi
    b. Zod
    c. Yup
    d. Validator.js

**Checklist:**
- [ ] Validasi dipisah ke `utils` dan `middlewares` (clean code).
- [ ] Tabel Category terbentuk di database.
- [ ] Endpoint `POST /categories` berhasil.
- [ ] Endpoint `POST /products` bisa menerima `categoryId`.
- [ ] Endpoint `GET /products` menampilkan detail kategori.
- [ ] 10 soal kuis berhasil dijawab.
