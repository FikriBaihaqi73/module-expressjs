# Pekan 2 - Hari 11: Error Handling & Best Practice Prisma

**HARI KE-11** ‚Äì Aplikasi yang Tangguh (Robust)
**Fokus hari ini:** Menangani error dengan elegan dan menulis kode Prisma yang efisien.

---

## 1. Centralized Error Handling

Jangan biarkan aplikasi crash atau loading terus saat error. Kita butuh mekanisme penanganan error terpusat.

### Middleware Error Handler
Buat di `src/index.ts` (paling bawah, sebelum `app.listen`).

```ts
// Middleware Error
app.use((err: any, req: Request, res: Response, next: NextFunction) => {
  console.error(err.stack); // Log error di server

  // Cek tipe error
  res.status(500).json({
    success: false,
    message: "Terjadi kesalahan pada server",
    error: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});
```

### Try-Catch Wrapper (Async Handler)
Supaya tidak perlu tulis `try-catch` di setiap route, kita bisa buat wrapper function. Atau gunakan library `express-async-errors`.

```bash
npm install express-async-errors
```
Import di paling atas `index.ts`:
```ts
import 'express-async-errors';
```
Sekarang kalau ada error di async function, otomatis masuk ke Error Middleware di atas!

---

## 2. Menangani Error Spesifik Prisma

Prisma punya kode error unik. Contoh: `P2002` (Unique Constraint Violation / Data Kembar).

Update Error Middleware kita:
```ts
import { Prisma } from '@prisma/client';

app.use((err: any, req: Request, res: Response, next: NextFunction) => {
  
  // Handle Error Prisma
  if (err instanceof Prisma.PrismaClientKnownRequestError) {
    if (err.code === 'P2002') {
      return res.status(400).json({
        success: false,
        message: "Data sudah ada (Unique constraint violation)",
        field: err.meta?.target
      });
    }
    if (err.code === 'P2025') {
      return res.status(404).json({
        success: false,
        message: "Data tidak ditemukan"
      });
    }
  }

  // Handle Error Validasi / Umum
  res.status(500).json({ success: false, message: err.message });
});
```

---

## 3. Soft Delete (Menghapus Tanpa Menghilangkan)

Di dunia nyata, data jarang benar-benar dihapus (Hard Delete) untuk keperluan audit/history. Kita pakai **Soft Delete**.

### Update Schema
Tambahkan kolom `deletedAt`.
```prisma
model Product {
  // ... field lain
  deletedAt DateTime? // Kalau null berarti aktif, kalau ada tanggal berarti dihapus
}
```

### Implementasi
**Delete:** Jangan `delete()`, tapi `update()`.
```ts
await prisma.product.update({
  where: { id: 1 },
  data: { deletedAt: new Date() }
});
```

**Read:** Filter yang `deletedAt` nya null.
```ts
await prisma.product.findMany({
  where: { deletedAt: null }
});
```

---

---

## 4. HTTP Status Codes (Kamus Kode Respon)

Agar frontend developer tidak bingung, backend harus mengirim kode status yang tepat.

| Code | Arti | Kapan Dipakai? |
| :--- | :--- | :--- |
| **200** | OK | Request berhasil (GET, PUT). |
| **201** | Created | Data berhasil dibuat (POST). |
| **400** | Bad Request | Input user salah (Validasi gagal). |
| **401** | Unauthorized | Belum login / Token tidak valid. |
| **403** | Forbidden | Sudah login, tapi tidak boleh akses (Bukan Admin). |
| **404** | Not Found | Data atau URL tidak ditemukan. |
| **500** | Internal Server Error | Server crash / Codingan error. |

---

## 5. Tugas Harian Hari Ke-11

**Misi:** Bikin API kamu "Anti-Crash" dan support Soft Delete.

1.  **Install `express-async-errors`:** Implementasikan di project.
2.  **Global Error Handler:** Buat middleware error di akhir file.
3.  **Handle Duplicate:** Coba insert Kategori dengan nama yang sama (pastikan field `name` di schema `@unique`). Pastikan response-nya rapi (400 Bad Request), bukan error HTML panjang.
4.  **Soft Delete:**
    - Tambah kolom `deletedAt` di Product.
    - Ubah endpoint DELETE menjadi Soft Delete.
    - Ubah endpoint GET agar tidak menampilkan produk yang sudah dihapus.

**Checklist:**
- [ ] Aplikasi tidak crash saat terjadi error database.
- [ ] Pesan error user-friendly (JSON).
- [ ] Soft delete berfungsi (data masih ada di DB tapi ada tanggal deletedAt).
- [ ] Get Products bersih dari barang yang dihapus.

---

**Tips:** Error handling membedakan aplikasi amatir dan profesional. User tidak perlu tahu detail error teknis, tapi developer butuh log-nya. üõ°Ô∏è

---

## 6. Kuis Pilihan Ganda (Latihan)

1. **Mengapa kita perlu Centralized Error Handling?**
   a. Agar kode error tersebar di mana-mana
   b. Agar penanganan error konsisten dan tidak perlu try-catch berulang di setiap controller
   c. Agar aplikasi sering crash
   d. Agar user bisa melihat stack trace error

2. **HTTP Status Code untuk "Data tidak ditemukan" adalah...**
   a. 200
   b. 400
   c. 404
   d. 500

3. **HTTP Status Code untuk "Internal Server Error" (Server Crash) adalah...**
   a. 200
   b. 401
   c. 404
   d. 500

4. **Apa itu "Soft Delete"?**
   a. Menghapus data secara permanen dari harddisk
   b. Menghapus tabel database
   c. Menandai data sebagai "terhapus" (misal dengan kolom `deletedAt`) tanpa benar-benar menghapusnya dari database
   d. Menghapus data dengan lembut

5. **Library `express-async-errors` berfungsi untuk...**
   a. Membuat aplikasi jadi lambat
   b. Menangani error di fungsi async secara otomatis tanpa perlu try-catch manual di setiap route
   c. Menghapus error
   d. Validasi input

6. **Jika user gagal login karena password salah, status code yang tepat adalah...**
   a. 200 OK
   b. 401 Unauthorized
   c. 404 Not Found
   d. 500 Error

7. **Kode error Prisma untuk "Unique Constraint Violation" (Data kembar) adalah...**
   a. P2002
   b. P404
   c. E11000
   d. ERROR_DUPLICATE

8. **Di mana sebaiknya kita meletakkan middleware Error Handler di Express?**
   a. Paling atas sebelum semua route
   b. Di tengah-tengah
   c. Paling bawah setelah semua route
   d. Tidak perlu dipasang

9. **Apa bahayanya menampilkan `err.stack` (Stack Trace) ke user di production?**
   a. Tidak bahaya
   b. User jadi tahu struktur folder dan celah keamanan server kita
   c. Tampilan jadi jelek
   d. Server jadi lambat

10. **Status code 201 Created biasanya digunakan setelah berhasil melakukan...**
    a. GET
    b. POST (Create Data)
    c. DELETE
    d. PUT
