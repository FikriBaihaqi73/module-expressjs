**pekan-1/hari-5.md**  
**HARI KE-5**  
**Topik Harian:** Struktur MVC dan REST API  
**Kompetensi (sesuai silabus):** Santri dapat menerapkan arsitektur MVC dalam aplikasi REST API  
**Indikator Penilaian:** Santri mampu mengimplementasikan struktur proyek berbasis MVC + pemisahan Controller & Service 
**Alokasi Waktu:** 10 jam  

Hari ini kita **REFACTOR TOTAL** proyek E-Commerce dari Hari 1–3 menjadi struktur MVC + Service yang bersih dan scalable!

### Mengapa Struktur MVC + Service Layer Penting?

Dengan memisahkan `Controller` (menangani request/response), `Service` (menangani logika bisnis), dan `Route` (mendefinisikan endpoint), kita mendapatkan beberapa manfaat utama:
1.  **Keterbacaan dan Keteraturan Kode**: Kode menjadi lebih mudah dibaca dan dipahami karena setiap bagian memiliki tanggung jawab yang jelas.
2.  **Kemudahan Pemeliharaan (Maintainability)**: Perubahan pada logika bisnis tidak akan mempengaruhi bagian routing atau controller secara langsung, membuat pemeliharaan lebih mudah.
3.  **Skalabilitas**: Aplikasi lebih mudah dikembangkan dan ditambahkan fitur baru karena setiap komponen dapat dimodifikasi atau diganti tanpa mempengaruhi bagian lain secara drastis.
4.  **Uji Coba (Testability)**: Logika bisnis di Service Layer menjadi lebih mudah untuk diuji secara independen, tanpa perlu menjalankan seluruh server atau controller.
5.  **Kolaborasi Tim**: Dalam tim pengembangan, setiap anggota bisa fokus pada lapisan yang berbeda tanpa banyak konflik.

### Struktur Folder Akhir Hari Ke-4 (WAJIB seperti ini!)

```
src/
├── controllers/      ← Menangani request HTTP masuk dan mengirimkan response. Berinteraksi dengan service layer.
│   └── product.controller.ts
├── services/         ← Berisi logika bisnis utama aplikasi. Berinteraksi dengan database (atau data in-memory di sini).
│   └── product.service.ts
├── routes/           ← Mendefinisikan endpoint API dan menghubungkannya ke controller yang relevan.
│   └── product.route.ts
├── models/           ← Berisi definisi struktur data (interface/class) atau interaksi langsung dengan database (ORM).
│   └── product.model.ts
├── types/            ← Berisi definisi tipe TypeScript global atau custom yang digunakan di seluruh aplikasi.
│   └── express.d.ts
├── middlewares/      ← Fungsi-fungsi yang dijalankan sebelum atau sesudah route handler utama (misal: error handling, auth).
│   └── error.handler.ts
├── utils/            ← Berisi fungsi-fungsi utilitas atau helper yang digunakan di berbagai tempat (misal: asyncHandler).
│   └── async.handler.ts
├── app.ts            ← Menginisialisasi aplikasi Express, mendaftarkan middleware dan routes.
└── index.ts          ← Titik masuk utama aplikasi, memulai server Express dan mengkonfigurasi environment.
```

### 1. Buat Folder & File Baru

```bash
mkdir src/controllers src/services src/routes src/models src/types src/middlewares src/utils
touch src/controllers/product.controller.ts
touch src/services/product.service.ts
touch src/routes/product.route.ts
touch src/models/product.model.ts
touch src/types/express.d.ts
touch src/middlewares/error.handler.ts
touch src/utils/async.handler.ts
touch src/app.ts
```

### 2. File-file Inti

// Catatan tentang `import` dan `export`:
// Di dalam struktur MVC ini, kita akan banyak menggunakan `import` dan `export` (ES Modules).
// `export` digunakan untuk membuat fungsi, kelas, atau variabel dapat diakses dari file lain.
// `import` digunakan untuk mengambil (menggunakan) fungsi, kelas, atau variabel yang telah di-export dari file lain.
// Ini adalah inti dari modularitas kode dan memisahkan 'concerns' di setiap lapisan aplikasi.

#### src/types/express.d.ts
// File ini digunakan untuk memperluas (augment) tipe `Request` bawaan dari Express.
// Karena kita menambahkan properti kustom seperti `startTime` dan `namaSantri` ke objek `req`
// di middleware, TypeScript perlu tahu tentang properti-properti ini agar tidak mengeluh error.
// `declare global` dan `namespace Express` memungkinkan kita melakukan ini dengan aman.
```ts
import { Request } from 'express';

declare global {
  namespace Express {
    interface Request {
      startTime?: number;
      namaSantri?: string;
    }
  }
}
```

#### src/utils/async.handler.ts
```ts
import { Request, Response, NextFunction } from 'express';

export const asyncHandler = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};
```

#### src/models/product.model.ts
// File ini mendefinisikan struktur data untuk produk dan berfungsi sebagai simulasi 'Model' 
// dalam konteks MVC saat kita belum terhubung ke database sungguhan. 
// Ini akan berisi data in-memory atau nanti akan berinteraksi dengan ORM (seperti Sequelize).
```ts
export interface Product {
  id: number;
  nama: string;
  deskripsi: string;
  harga: number;
}

export let products: Product[] = [
  { id: 1, nama: "Laptop Gaming", deskripsi: "Intel i7, RTX 3060", harga: 15000000 },
  { id: 2, nama: "Keyboard Mekanikal", deskripsi: "Blue Switch, RGB", harga: 800000 },
  { id: 3, nama: "Mouse Wireless", deskripsi: "Ergonomic, Silent Click", harga: 300000 }
];
```

#### src/services/product.service.ts (BUSINESS LOGIC DI SINI!)
// Service Layer berisi semua logika bisnis aplikasi. 
// Ia berinteraksi dengan Model (data) dan menyediakan fungsionalitas yang digunakan oleh Controller.
// Di sini kita akan berinteraksi dengan data `products` dari `product.model.ts`.
```ts
import { Product, products } from '../models/product.model';

export class ProductService {
  static getAll(): Product[] {
    return products;
  }

  static getById(id: number): Product {
    const product = products.find(p => p.id === id);
    if (!product) throw new Error('Produk tidak ditemukan');
    return product;
  }

  static create(data: { nama: string; deskripsi: string; harga: number }): Product {
    // Validasi input sekarang ditangani oleh express-validator di layer route/controller (Hari 3),
    // sehingga tidak perlu validasi manual di Service Layer.
    const newProduct = {
      id: products.length + 1,
      ...data
    };
    products.push(newProduct);
    return newProduct;
  }

  static update(id: number, data: Partial<Product>): Product {
    // `Partial<Product>` adalah utilitas tipe dari TypeScript yang membuat semua properti
    // dari `Product` menjadi opsional. Ini sangat cocok untuk operasi `update` 
    // di mana kita mungkin hanya ingin mengubah sebagian properti dari objek produk,
    // bukan seluruh objek.
    const index = products.findIndex(p => p.id === id);
    if (index === -1) throw new Error('Produk tidak ditemukan');
    products[index] = { ...products[index], ...data };
    return products[index];
  }

  static delete(id: number): Product {
    const index = products.findIndex(p => p.id === id);
    if (index === -1) throw new Error('Produk tidak ditemukan');
    return products.splice(index, 1)[0];
  }
}
```

#### src/controllers/product.controller.ts (HANYA TERIMA REQUEST & KIRIM RESPONSE)
**Penjelasan Controller:**
Controller adalah lapisan yang berinteraksi langsung dengan HTTP request dan response. 
Tugas utamanya adalah menerima input dari klien, meneruskan ke Service Layer untuk diproses, 
dan mengembalikan hasil ke klien. Controller **tidak boleh** mengandung logika bisnis (seperti manipulasi data langsung);
itu adalah tanggung jawab Service Layer.

```ts
import { Request, Response } from 'express';
import { ProductService } from '../services/product.service';
import { asyncHandler } from '../utils/async.handler';

// Import response helpers (jika belum ada, bisa ditambahkan dari Hari 3)
// import { successResponse, errorResponse } from '../utils/responses';

// Import validasi dari Hari 3 (jika belum ada, bisa ditambahkan)
// import { validate, createProductValidation, getProductByIdValidation } from '../validations/productValidation';

export const getAllProducts = asyncHandler(async (req: Request, res: Response) => {
  const products = ProductService.getAll();
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    count: products.length,
    data: products
  });
});

export const getProductById = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const product = ProductService.getById(id);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({ success: true, data: product });
});

export const createProduct = asyncHandler(async (req: Request, res: Response) => {
  const product = ProductService.create(req.body);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.status(201).json({
    success: true,
    message: 'Produk berhasil ditambahkan',
    data: product
  });
});

export const updateProduct = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const product = ProductService.update(id, req.body);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    message: 'Produk berhasil diupdate',
    data: product
  });
});

export const deleteProduct = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const product = ProductService.delete(id);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    message: 'Produk berhasil dihapus',
    data: product
  });
});
```

#### src/routes/product.route.ts
```ts
// Route Layer bertanggung jawab untuk mendefinisikan semua endpoint API 
// dan mengarahkan request ke controller yang sesuai. 
// Ia tidak boleh memiliki logika bisnis atau memanipulasi data secara langsung.
import { Router } from 'express';
import {
  getAllProducts,
  getProductById,
  createProduct,
  updateProduct,
  deleteProduct
} from '../controllers/product.controller';

// Import response helpers dan validasi dari Hari 3 (jika sudah ada)
// import { validate, createProductValidation, getProductByIdValidation } from '../validations/productValidation';

const router = Router();

// Tambahkan validasi ke route di sini jika ingin diterapkan langsung di router level
router.get('/', getAllProducts);
router.get('/:id', getProductById);
router.post('/', createProduct);
router.put('/:id', updateProduct);
router.delete('/:id', deleteProduct);

export default router;
```

#### Pemisahan `app.ts` dan `index.ts`:
Pemisahan ini adalah praktik terbaik untuk aplikasi Express.
`app.ts` berisi konfigurasi aplikasi Express (middleware, routes, error handling) 
tetapi tidak memulai server. Ini memungkinkan `app` di-*export* dan digunakan 
untuk tujuan pengujian (menjalankan tes tanpa harus memulai server HTTP yang sebenarnya).
`index.ts` adalah file utama yang bertanggung jawab untuk mengimpor aplikasi (`app`) 
dan memulai server HTTP, biasanya juga memuat konfigurasi lingkungan (`dotenv`).

#### src/app.ts
```ts
import express from 'express';
import morgan from 'morgan';
import helmet from 'helmet';
import cors from 'cors';
import productRoutes from './routes/product.route';
import { errorHandler } from './middlewares/error.handler';

const app = express();

app.use(helmet());
app.use(cors());
app.use(morgan('dev'));
app.use(express.json());

// Custom middleware (dari Hari 3)
app.use((req, res, next) => {
  req.startTime = Date.now();
  const nama = req.headers['x-nama-santri'] as string;
  if (!nama) return res.status(400).json({ success: false, message: 'Kirim header X-Nama-Santri' });
  req.namaSantri = nama;
  next();
});

// Routes
app.get('/', (req, res) => {
  const waktu = Date.now() - (req.startTime || 0);
  res.json({ message: `Halo ${req.namaSantri}! Hari 5 – MVC E-Commerce + Service`, waktu_proses: `${waktu}ms` });
});

app.use('/api/products', productRoutes);

// Error handler harus di paling bawah!
// Middleware error handling dengan 4 parameter (`err, req, res, next`) harus selalu 
// diletakkan PALING AKHIR di antara semua middleware dan route lainnya. 
// Ini memastikan bahwa semua error dari route atau middleware sebelumnya 
// dapat ditangkap dan diproses secara terpusat.
app.use(errorHandler);

export default app;
```

#### src/middlewares/error.handler.ts
```ts
import { Request, Response, NextFunction } from 'express';

export const errorHandler = (err: any, req: Request, res: Response, next: NextFunction) => {
  console.error('ERROR:', err.message);

  const statusCode = err.message.includes('tidak ditemukan') ? 404 : 400;

  res.status(statusCode).json({
    success: false,
    message: err.message,
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};
```

#### src/index.ts
```ts
import app from './app';
import dotenv from 'dotenv';

dotenv.config();
const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`Server MVC + Service E-Commerce jalan di http://localhost:${PORT}`);
});
```

### TUGAS HARIAN HARI KE-5 (KERJAKAN SENDIRI!)

1. Buat struktur folder persis seperti di atas (dengan folder `models`)
2. Pindahkan semua kode dari `src/index.ts` lama ke file-file baru (pastikan middleware, error handling, dan validasi dari Hari 3 sudah terintegrasi ke dalam `app.ts` atau middleware global)
3. Pastikan semua route masih berjalan sama seperti Hari 3 (dengan middleware, error handling, dan validasi yang sudah diintegrasikan)
4. Tambahkan 1 route baru:
   - `GET /api/products/search?nama=...` → cari berdasarkan nama produk (buat di Service!)

### Checklist Penilaian Hari Ke-5

*   [ ] Folder structure MVC + Service + Model sudah rapi
*   [ ] Tidak ada business logic di controller (semua di Service Layer)
*   [ ] Semua route pakai asyncHandler
*   [ ] Error tetap ditangkap rapi (menggunakan global error handler)
*   [ ] Validasi input berfungsi dengan baik (dari Hari 3)
*   [ ] Response API konsisten (menggunakan response helper dari Hari 3)
*   [ ] Bisa search produk berdasarkan nama
*   [ ] Commit message: `"Hari 5: Refactor ke MVC + Service Layer + Model (E-Commerce)"`