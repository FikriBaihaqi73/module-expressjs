**pekan-1/hari-5.md**  
**HARI KE-5**  
**Topik Harian:** Struktur MVC dan REST API  
**Kompetensi (sesuai silabus):** Santri dapat menerapkan arsitektur MVC dalam aplikasi REST API  
**Indikator Penilaian:** Santri mampu mengimplementasikan struktur proyek berbasis MVC + pemisahan Controller & Service 
**Alokasi Waktu:** 10 jam  

Hari ini kita **REFACTOR TOTAL** proyek Toko Buku dari Hari 1–3 menjadi struktur MVC + Service yang bersih dan scalable!

### Mengapa Struktur MVC + Service Layer Penting?

Dengan memisahkan `Controller` (menangani request/response), `Service` (menangani logika bisnis), dan `Route` (mendefinisikan endpoint), kita mendapatkan beberapa manfaat utama:
1.  **Keterbacaan dan Keteraturan Kode**: Kode menjadi lebih mudah dibaca dan dipahami karena setiap bagian memiliki tanggung jawab yang jelas.
2.  **Kemudahan Pemeliharaan (Maintainability)**: Perubahan pada logika bisnis tidak akan mempengaruhi bagian routing atau controller secara langsung, membuat pemeliharaan lebih mudah.
3.  **Skalabilitas**: Aplikasi lebih mudah dikembangkan dan ditambahkan fitur baru karena setiap komponen dapat dimodifikasi atau diganti tanpa mempengaruhi bagian lain secara drastis.
4.  **Uji Coba (Testability)**: Logika bisnis di Service Layer menjadi lebih mudah untuk diuji secara independen, tanpa perlu menjalankan seluruh server atau controller.
5.  **Kolaborasi Tim**: Dalam tim pengembangan, setiap anggota bisa fokus pada lapisan yang berbeda tanpa banyak konflik.

### Struktur Folder Akhir Hari Ke-4 (WAJIB seperti ini!)

```
src/
├── controllers/
│   └── bookController.ts
├── services/
│   └── bookService.ts
├── routes/
│   └── bookRoutes.ts
├── types/
│   └── express.d.ts          ← biar any tidak muncul
├── middlewares/
│   └── errorHandler.ts
├── utils/
│   └── asyncHandler.ts
├── app.ts
└── index.ts                  ← server start
```

### 1. Buat Folder & File Baru

```bash
mkdir src/controllers src/services src/routes src/types src/middlewares src/utils
touch src/controllers/bookController.ts
touch src/services/bookService.ts
touch src/routes/bookRoutes.ts
touch src/types/express.d.ts
touch src/middlewares/errorHandler.ts
touch src/utils/asyncHandler.ts
touch src/app.ts
```

### 2. File-file Inti

#### src/types/express.d.ts
```ts
import { Request } from 'express';

declare global {
  namespace Express {
    interface Request {
      startTime?: number;
      namaSantri?: string;
    }
  }
}
```

#### src/utils/asyncHandler.ts
```ts
import { Request, Response, NextFunction } from 'express';

export const asyncHandler = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};
```

#### src/services/bookService.ts (BUSINESS LOGIC DI SINI!)
```ts
// Ini yang nanti akan diganti Sequelize
interface Buku {
  id: number;
  judul: string;
  penulis: string;
  harga: number;
}

let books: Buku[] = [
  { id: 1, judul: "Belajar Node.js", penulis: "Ahmad", harga: 75000 },
  { id: 2, judul: "TypeScript untuk Pemula", penulis: "Siti", harga: 90000 },
  { id: 3, judul: "Express.js dari Nol", penulis: "Budi", harga: 120000 }
];

export class BookService {
  static getAll() {
    return books;
  }

  static getById(id: number) {
    const buku = books.find(b => b.id === id);
    if (!buku) throw new Error('Buku tidak ditemukan');
    return buku;
  }

  static create(data: { judul: string; penulis: string; harga: number }) {
    // Validasi input sekarang ditangani oleh express-validator di layer route/controller (Hari 3),
    // sehingga tidak perlu validasi manual di Service Layer.
    const bukuBaru = {
      id: books.length + 1,
      ...data
    };
    books.push(bukuBaru);
    return bukuBaru;
  }

  static update(id: number, data: Partial<Buku>) {
    const index = books.findIndex(b => b.id === id);
    if (index === -1) throw new Error('Buku tidak ditemukan');
    books[index] = { ...books[index], ...data };
    return books[index];
  }

  static delete(id: number) {
    const index = books.findIndex(b => b.id === id);
    if (index === -1) throw new Error('Buku tidak ditemukan');
    return books.splice(index, 1)[0];
  }
}
```

#### src/controllers/bookController.ts (HANYA TERIMA REQUEST & KIRIM RESPONSE)
```ts
import { Request, Response } from 'express';
import { BookService } from '../services/bookService';
import { asyncHandler } from '../utils/asyncHandler';

// Import response helpers (jika belum ada, bisa ditambahkan dari Hari 3)
// import { successResponse, errorResponse } from '../utils/responses';

// Import validasi dari Hari 3 (jika belum ada, bisa ditambahkan)
// import { validate, createBookValidation, getBookByIdValidation } from '../validations/bookValidation';

export const getAllBooks = asyncHandler(async (req: Request, res: Response) => {
  const books = BookService.getAll();
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    count: books.length,
    data: books
  });
});

export const getBookById = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const buku = BookService.getById(id);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({ success: true, data: buku });
});

export const createBook = asyncHandler(async (req: Request, res: Response) => {
  const buku = BookService.create(req.body);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.status(201).json({
    success: true,
    message: 'Buku berhasil ditambahkan',
    data: buku
  });
});

export const updateBook = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const buku = BookService.update(id, req.body);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    message: 'Buku berhasil diupdate',
    data: buku
  });
});

export const deleteBook = asyncHandler(async (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const buku = BookService.delete(id);
  // Gunakan successResponse dari Hari 3 jika sudah diimplementasikan
  res.json({
    success: true,
    message: 'Buku berhasil dihapus',
    data: buku
  });
});
```

#### src/routes/bookRoutes.ts
```ts
import { Router } from 'express';
import {
  getAllBooks,
  getBookById,
  createBook,
  updateBook,
  deleteBook
} from '../controllers/bookController';

// Import response helpers dan validasi dari Hari 3 (jika sudah ada)
// import { validate, createBookValidation, getBookByIdValidation } from '../validations/bookValidation';

const router = Router();

// Tambahkan validasi ke route di sini jika ingin diterapkan langsung di router level
router.get('/', getAllBooks);
router.get('/:id', getBookById);
router.post('/', createBook);
router.put('/:id', updateBook);
router.delete('/:id', deleteBook);

export default router;
```

#### src/app.ts
```ts
import express from 'express';
import morgan from 'morgan';
import helmet from 'helmet';
import cors from 'cors';
import bookRoutes from './routes/bookRoutes';
import { errorHandler } from './middlewares/errorHandler';

const app = express();

app.use(helmet());
app.use(cors());
app.use(morgan('dev'));
app.use(express.json());

// Custom middleware (dari Hari 3)
app.use((req, res, next) => {
  req.startTime = Date.now();
  const nama = req.headers['x-nama-santri'] as string;
  if (!nama) return res.status(400).json({ success: false, message: 'Kirim header X-Nama-Santri' });
  req.namaSantri = nama;
  next();
});

// Routes
app.get('/', (req, res) => {
  const waktu = Date.now() - (req.startTime || 0);
  res.json({ message: `Halo ${req.namaSantri}! Hari 4 – MVC + Service`, waktu_proses: `${waktu}ms` });
});

app.use('/api/buku', bookRoutes);

// Error handler harus di paling bawah!
app.use(errorHandler);

export default app;
```

#### src/middlewares/errorHandler.ts
```ts
import { Request, Response, NextFunction } from 'express';

export const errorHandler = (err: any, req: Request, res: Response, next: NextFunction) => {
  console.error('ERROR:', err.message);

  const statusCode = err.message.includes('tidak ditemukan') ? 404 : 400;

  res.status(statusCode).json({
    success: false,
    message: err.message,
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};
```

#### src/index.ts
```ts
import app from './app';
import dotenv from 'dotenv';

dotenv.config();
const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  console.log(`Server MVC + Service jalan di http://localhost:${PORT}`);
});
```

### TUGAS HARIAN HARI KE-4 (KERJAKAN SENDIRI!)

1. Buat struktur folder persis seperti di atas
2. Pindahkan semua kode dari `src/index.ts` lama ke file-file baru (pastikan middleware, error handling, dan validasi dari Hari 3 sudah terintegrasi ke dalam `app.ts` atau middleware global)
3. Pastikan semua route masih berjalan sama seperti Hari 3 (dengan middleware, error handling, dan validasi yang sudah diintegrasikan)
4. Tambahkan 1 route baru:
   - `GET /api/buku/search?judul=...` → cari berdasarkan judul (buat di Service!)

### Checklist Penilaian Hari Ke-4

*   [ ] Folder structure MVC + Service sudah rapi
*   [ ] Tidak ada business logic di controller (semua di Service Layer)
*   [ ] Semua route pakai asyncHandler
*   [ ] Error tetap ditangkap rapi (menggunakan global error handler)
*   [ ] Validasi input berfungsi dengan baik (dari Hari 3)
*   [ ] Response API konsisten (menggunakan response helper dari Hari 3)
*   [ ] Bisa search buku berdasarkan judul
*   [ ] Commit message: `"Hari 4: Refactor ke MVC + Service Layer"`

### Bonus

*   Buat folder `dtos/` untuk CreateBookDto
*   Pakai class-validator nanti (opsional)

**Selamat! Sekarang kode kamu sudah siap masuk ke database minggu depan!**  
Hari ini fondasi terpenting: **pisah concern** → Controller hanya terima request, Service urus logika.

Besok Hari Ke-5: Studi Kasus Mini API ToDo List (tanpa DB) → kita pakai struktur ini full!

Kerjakan tugas ini sampai beres malam ini ya!  
Kalau sudah selesai → push + kirim link repo.

**Semangat santri! Kamu sudah masuk level menengah backend!**
