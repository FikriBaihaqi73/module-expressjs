**pekan-1/hari-3.md**  
**HARI KE-3**  
**Topik Harian:** Middleware dan Error Handling  
**Kompetensi:** Santri dapat menerapkan middleware dan error handler  
**Indikator Penilaian:** Santri mampu mengelola middleware dan menangani error dengan rapi  
**Alokasi Waktu:** 10 jam  

### MATERI HARI KE-3 – SANTAI TAPI KUAT!

Hari ini kita **TIDAK** bikin struktur MVC dulu (itu Hari 4).  
Kita tetap satu file `src/index.ts`, tapi kita tambah 4 hal penting:

1. Middleware logging (morgan)
2. Custom middleware
3. Global Error Handler (supaya error tidak crash server + response rapi)
4. Async Handler (biar nanti pas pakai database tidak pusing try-catch)

### 1. Install Package Tambahan

```bash
npm install morgan helmet cors
npm install -D @types/morgan @types/cors
```

### 2. Kode Lengkap Hari 3 (src/index.ts)  
**Copy dulu sebagai contoh, lalu kamu kembangkan sendiri di tugas!**

```ts
import express, { Request, Response, NextFunction } from 'express';
import dotenv from 'dotenv';
import morgan from 'morgan';
import helmet from 'helmet';
import cors from 'cors';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// ==================== MIDDLEWARE ====================

app.use(helmet());                    // keamanan header
app.use(cors());                      // biar bisa diakses dari frontend
app.use(morgan('dev'));               // logger cantik di terminal
app.use(express.json());              // baca body JSON

// 1. Custom Middleware – Tambah timestamp ke setiap request
app.use((req: Request, res: Response, next: NextFunction) => {
  console.log(`Request masuk: ${req.method} ${req.path}`);
  (req as any).startTime = Date.now();
  next();
});

// 2. Custom Middleware – Cek apakah ada header X-Nama-Santri
app.use((req: Request, res: Response, next: NextFunction) => {
  const nama = req.headers['x-nama-santri'];
  if (!nama) {
    return res.status(400).json({
      success: false,
      message: "Header X-Nama-Santri wajib diisi ya!"
    });
  }
  (req as any).namaSantri = nama;
  next();
});

// ==================== DATA BUKU (sambung dari Hari 2) ====================
interface Buku {
  id: number;
  judul: string;
  penulis: string;
  harga: number;
}

let books: Buku[] = [
  { id: 1, judul: "Belajar Node.js", penulis: "Ahmad", harga: 75000 },
  { id: 2, judul: "TypeScript untuk Pemula", penulis: "Siti", harga: 90000 },
  { id: 3, judul: "Express.js dari Nol", penulis: "Budi", harga: 120000 }
];

// ==================== ROUTES (sama seperti Hari 2 + tambahan) ====================

app.get('/', (req: Request, res: Response) => {
  const waktuProses = Date.now() - (req as any).startTime;
  res.json({
    success: true,
    message: `Halo ${(req as any).namaSantri}! API Toko Buku – Hari 3`,
    waktu_proses_ms: waktuProses
  });
});

app.get('/api/buku', (req: Request, res: Response) => {
  res.json({
    success: true,
    count: books.length,
    data: books
  });
});

app.get('/api/buku/:id', (req: Request, res: Response) => {
  const id = parseInt(req.params.id);
  const buku = books.find(b => b.id === id);

  if (!buku) {
    // Kita lempar error → nanti ditangkap global error handler
    throw new Error('Buku dengan ID tersebut tidak ditemukan');
  }

  res.json({ success: true, data: buku });
});

app.post('/api/buku', (req: Request, res: Response) => {
  const { judul, penulis, harga } = req.body;

  if (!judul || !penulis || !harga) {
    throw new Error('Judul, penulis, dan harga wajib diisi semua');
  }

  const bukuBaru: Buku = {
    id: books.length + 1,
    judul,
    penulis,
    harga: Number(harga)
  };

  books.push(bukuBaru);

  res.status(201).json({
    success: true,
    message: 'Buku berhasil ditambahkan',
    data: bukuBaru
  });
});

// ==================== ERROR HANDLING ====================

// Async handler (biar tidak perlu try-catch di setiap route)
const asyncHandler = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    // Promise.resolve digunakan untuk memastikan fungsi fn yang dijalankan selalu mengembalikan Promise.
    // Ini penting agar .catch(next) dapat menangkap error yang terjadi, baik dari fungsi async
    // maupun fungsi synchronous yang melempar error. Tanpa asyncHandler, setiap fungsi controller
    // yang bersifat async dan berpotensi melempar error perlu dibungkus dengan try-catch manual.
    Promise.resolve(fn(req, res, next)).catch(next);
  };
};

// Contoh route async (nanti dipakai pas Sequelize)
app.get('/api/test-async', asyncHandler(async (req: Request, res: Response) => {
  await new Promise(resolve => setTimeout(resolve, 100));
  res.json({ message: "Async berhasil!" });
}));

// 404 Handler
app.use('*', (req: Request, res: Response) => {
  throw new Error(`Route ${req.originalUrl} tidak ada bro`);
});

// Global Error Handler – INI YANG PALING PENTING HARI INI
app.use((err: any, req: Request, res: Response, next: NextFunction) => {
  console.error('ERROR:', err.message);

  // Kalau error dari kita sendiri
  const statusCode = err.message.includes('tidak ditemukan') ? 404 : 400;

  res.status(statusCode).json({
    success: false,
    message: err.message || 'Terjadi kesalahan server',
    // hanya tampilkan stack kalau development
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
});

app.listen(PORT, () => {
  console.log(`Server HARI 3 jalan di http://localhost:${PORT}`);
  console.log(`Jangan lupa kirim header: X-Nama-Santri: NamaKamu`);
});
```

### TUGAS HARIAN HARI KE-3 (KERJAKAN SENDIRI!)

Kembangkan API Toko Buku kamu dari Hari 2 jadi seperti ini:

1. Tambahkan **morgan**, **helmet**, **cors**
2. Buat **2 custom middleware**:
   - Yang cek header `X-Nama-Santri` (wajib ada)
   - Yang hitung berapa milidetik proses request (tampilkan di response)
3. Semua error (buku tidak ada, field kurang, route salah) harus:
   - Lempar dengan `throw new Error("pesan")`
   - Harus ditangkap global error handler → return JSON rapi
4. Tambahkan route baru:
   - `GET /api/error-test` → sengaja lempar error
   - `GET /api/async-test` → pakai asyncHandler
5. Semua response harus punya format:
   ```json
   {
     "success": true/false,
     "message": "...",
     "data": {...},
     "waktu_proses_ms": 12
   }
   ```

### Checklist Penilaian Hari Ke-3 (Centang semua!)

- [ ] morgan muncul log warna-warni di terminal
- [ ] Kalau tidak kirim header `X-Nama-Santri` → error 400
- [ ] Buka route yang salah → error 404 rapi
- [ ] Cari buku ID 999 → error 404 rapi
- [ ] POST tanpa judul → error 400 rapi
- [ ] Ada waktu proses di setiap response
- [ ] Commit message: `"Hari 3: Middleware + Global Error Handler + Async Handler"`

### Bonus (Kalau Cepat)
-cepatt)

- Buat middleware yang cek apakah harga > 0
- Buat middleware yang batasi request (max 10 per menit) – pakai variabel sederhana

**Besok Hari Ke-4 baru kita pisah ke struktur MVC (routes, controllers, dll)**

Santai aja, hari ini fokusnya:  
**“Kalau ada error, server tetap hidup & response tetap JSON rapi”**

Kerjakan tugas ini sampai benar-benar mengerti.  
Kalau sudah selesai, push ke GitHub + kirim link repo ke grup.

**Semangat santri! Hari ini kamu jadi jauh lebih pro!**