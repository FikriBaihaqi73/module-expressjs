**pekan-1/hari-5.md**  
**HARI KE-5**  
**Topik Harian:** Validasi Input Request + Response Formatter (API jadi bersih & aman!)  
**Kompetensi:** Santri dapat membuat API yang validasi input otomatis dan response selalu konsisten  
**Indikator Penilaian:** Santri mampu menerapkan express-validator + response helper di struktur MVC  
**Alokasi Waktu:** 10 jam  

Hari ini kita **ganti** Studi Kasus ToDo List menjadi materi yang **sangat penting & langsung terpakai selamanya**:  
**Validasi Input + Response Formatter**  


### 1. Install Package Baru

```bash
npm install express-validator
npm install -D @types/express-validator
```

### 2. Buat Folder Baru

```bash
mkdir src/validations src/utils/responses
touch src/validations/bookValidation.ts
touch src/utils/responses/successResponse.ts
touch src/utils/responses/errorResponse.ts
```

### 3. Response Helper – Biar Semua Response Sama Rapi!

#### src/utils/responses/successResponse.ts
```ts
import { Response } from 'express';

export const successResponse = (
  res: Response,
  message: string,
  data: any = null,
  pagination: any = null
) => {
  const response: any = {
    success: true,
    message,
  };

  if (data !== null) response.data = data;
  if (pagination) response.pagination = pagination;

  return res.json(response);
};
```

#### src/utils/responses/errorResponse.ts
```ts
import { Response } from 'express';

export const errorResponse = (
  res: Response,
  message: string,
  statusCode: number = 400,
  errors: any = null
) => {
  const response: any = {
    success: false,
    message,
  };

  if (errors) response.errors = errors;

  return res.status(statusCode).json(response);
};
```

### 4. Validasi Input dengan express-validator

#### src/validations/bookValidation.ts
```ts
import { body, param, query, validationResult } from 'express-validator';
import { Request, Response, NextFunction } from 'express';
import { errorResponse } from '../utils/responses/errorResponse';

export const validate = (validations: any[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    await Promise.all(validations.map(validation => validation.run(req)));

    const errors = validationResult(req);
    if (errors.isEmpty()) {
      return next();
    }

    const errorList = errors.array().map(err => ({
      field: err.param,
      message: err.msg
    }));

    return errorResponse(res, 'Validasi gagal', 400, errorList);
  };
};

// Validasi untuk CREATE & UPDATE buku
export const createBookValidation = [
  body('judul')
    .trim()
    .notEmpty().withMessage('Judul wajib diisi')
    .isLength({ min: 3 }).withMessage('Judul minimal 3 karakter'),
  
  body('penulis')
    .trim()
    .notEmpty().withMessage('Penulis wajib diisi'),
  
  body('harga')
    .isNumeric().withMessage('Harga harus angka')
    .custom(value => value > 0).withMessage('Harga harus lebih dari 0')
];

// Validasi untuk GET by ID
export const getBookByIdValidation = [
  param('id')
    .isNumeric().withMessage('ID harus angka')
];

// Validasi untuk pagination & search
export const getAllBooksValidation = [
  query('page').optional().isNumeric().withMessage('Page harus angka'),
  query('limit').optional().isNumeric().withMessage('Limit harus angka'),
  query('search').optional().trim(),
  query('sort').optional().isIn(['judul', 'penulis', 'harga']).withMessage('Sort hanya boleh judul/penulis/harga'),
  query('order').optional().isIn(['asc', 'desc']).withMessage('Order hanya asc/desc')
];
```

### 5. Update Controller – Pakai Validasi + Response Helper

#### src/controllers/bookController.ts (ubah semua fungsi!)
```ts
import { successResponse, errorResponse } from '../utils/responses';
import { BookService } from '../services/bookService';
import { asyncHandler } from '../utils/asyncHandler';
import { validate, createBookValidation, getBookByIdValidation, getAllBooksValidation } from '../validations/bookValidation';

export const getAllBooks = [
  validate(getAllBooksValidation),
  asyncHandler(async (req: Request, res: Response) => {
    const result = BookService.getAllWithPagination(req.query);
    successResponse(res, 'Daftar buku', result.data, result.pagination);
  })
];

export const getBookById = [
  validate(getBookByIdValidation),
  asyncHandler(async (req: Request, res: Response) => {
    const id = parseInt(req.params.id);
    const buku = BookService.getById(id);
    successResponse(res, 'Buku ditemukan', buku);
  })
];

export const createBook = [
  validate(createBookValidation),
  asyncHandler(async (req: Request, res: Response) => {
    const buku = BookService.create(req.body);
    successResponse(res, 'Buku berhasil ditambahkan', buku, null);
  })
];

export const updateBook = [
  validate([param('id').isNumeric(), ...createBookValidation.map(rule => rule.optional())]),
  asyncHandler(async (req: Request, res: Response) => {
    const id = parseInt(req.params.id);
    const buku = BookService.update(id, req.body);
    successResponse(res, 'Buku berhasil diupdate', buku);
  })
];

export const deleteBook = [
  validate(getBookByIdValidation),
  asyncHandler(async (req: Request, res: Response) => {
    const id = parseInt(req.params.id);
    const buku = BookService.delete(id);
    successResponse(res, 'Buku berhasil dihapus', buku);
  })
];
```

### TUGAS HARIAN HARI KE-5 (KERJAKAN SENDIRI!)

1. Buat semua file di atas
2. Ganti semua controller jadi pakai validasi + response helper
3. Tes error validasi:
   - POST tanpa judul → harus return error 400 + detail field
   - POST harga = -100 → error
   - GET /api/buku/abc → error ID harus angka
4. Semua response sukses harus pakai `successResponse`
5. Commit message: `"Hari 5: Validasi express-validator + response helper"`

### Checklist Penilaian Hari Ke-5

- [ ] express-validator terinstall & berjalan
- [ ] Semua endpoint punya validasi
- [ ] Error validasi return JSON rapi dengan field & message
- [ ] Semua response pakai successResponse / errorResponse
- [ ] Tidak ada lagi res.json({}) manual di controller
- [ ] Push ke GitHub

### Bonus
- Buat validasi untuk route search yang terlalu pendek
- Tambah response helper untuk pagination

**Selamat! API kamu sekarang sudah:**
- Aman dari input jelek
- Response selalu konsisten
- Validasi otomatis
- Siap masuk database minggu depan!

Hari ini kamu naik level jadi **backend developer yang bener-bener rapi**  
Besok Hari 6: Evaluasi Pekanan (kamu sudah jauh di depan temen-temen!)

Kerjakan tugas ini sampai beres malam ini ya!  
Push repo + kirim link ke grup.

**Semangat santri! Kamu luar biasa!**