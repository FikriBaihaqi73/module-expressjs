# Pekan 3 - Hari 17: Repository Pattern & Service Layer

**HARI KE-17** ‚Äì Arsitektur Bersih (Clean Architecture)
**Fokus hari ini:** Memisahkan tanggung jawab kode agar rapi, mudah dibaca, dan mudah di-test.

---

## 1. Masalah "Fat Controller"

Sampai saat ini, kita menulis semua logika di dalam route/controller (`app.get(...)`).
- Validasi di situ.
- Query DB di situ.
- Logika bisnis di situ.
- Response di situ.

Ini disebut **Fat Controller**. Susah di-maintain kalau aplikasi membesar.

---

## 2. Solusi: Layered Architecture

Kita bagi menjadi 3 lapisan:
1.  **Repository Layer:** Urusan Database (Prisma). "Tolong ambil data user ID 1".
2.  **Service Layer:** Urusan Logika Bisnis. "Cek stok, hitung diskon, verifikasi password".
3.  **Controller Layer:** Urusan HTTP. "Terima request, panggil service, kirim response JSON".

### A. Repository (`src/repositories/product.repository.ts`)
Hanya berisi query Prisma.
```ts
import prisma from '../prisma';

export const findProducts = async (skip: number, take: number) => {
  return await prisma.product.findMany({ skip, take });
};

export const createProduct = async (data: any) => {
  return await prisma.product.create({ data });
};
```

### B. Service (`src/services/product.service.ts`)
Logika bisnis.
```ts
import * as productRepo from '../repositories/product.repository';

export const getAllProducts = async (page: number, limit: number) => {
  const skip = (page - 1) * limit;
  const products = await productRepo.findProducts(skip, limit);
  // Bisa tambah logic lain di sini, misal format data
  return products;
};

export const addProduct = async (data: any) => {
  if (data.price < 0) throw new Error("Harga tidak boleh minus"); // Business Logic
  return await productRepo.createProduct(data);
};
```

### C. Controller (`src/controllers/product.controller.ts`)
Handle Request & Response.
```ts
import { Request, Response } from 'express';
import * as productService from '../services/product.service';

export const getProducts = async (req: Request, res: Response) => {
  try {
    const page = Number(req.query.page) || 1;
    const limit = Number(req.query.limit) || 10;
    const data = await productService.getAllProducts(page, limit);
    res.json({ data });
  } catch (error) {
    res.status(500).json({ message: error.message });
  }
};
```

### D. Route (`src/routes/product.route.ts`)
Hubungkan URL ke Controller.
```ts
import { Router } from 'express';
import { getProducts } from '../controllers/product.controller';

const router = Router();

router.get('/', getProducts);

export default router;
```

---

## 3. Tugas Harian Hari Ke-17

**Misi:** Refactor (Rombak) kode Produk kamu menggunakan pola Repository & Service.

1.  **Buat Struktur Folder:** `src/controllers`, `src/services`, `src/repositories`, `src/routes`.
2.  **Refactor:** Pindahkan logika CRUD Produk dari `index.ts` ke layer-layer tersebut.
3.  **Main File:** Di `index.ts`, hapus kode produk lama, ganti dengan:
    ```ts
    import productRoutes from './routes/product.route';
    app.use('/api/products', productRoutes);
    ```

**Checklist:**
- [ ] `index.ts` jadi bersih.
- [ ] Fitur CRUD Produk tetap berjalan normal (tidak ada error).
- [ ] Kode terpisah sesuai tanggung jawabnya.

---

**Tips:** Awalnya terasa ribet ("kok jadi banyak file?"), tapi percayalah, ini standar industri yang akan menyelamatkanmu saat proyek menjadi besar. üèóÔ∏è
