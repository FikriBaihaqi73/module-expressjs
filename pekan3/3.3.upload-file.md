# Pekan 3 - Hari 15: Upload File (Multer)

**HARI KE-15** â€“ Menangani Media
**Fokus hari ini:** Mengizinkan user mengupload gambar produk.

---

## 1. Persiapan Multer

`multer` adalah middleware node.js untuk menangani `multipart/form-data`.

```bash
npm install multer @types/multer
```

### Konfigurasi Storage
Buat folder `public/uploads` di root project.
Buat file `src/middlewares/upload.ts`.

```ts
import multer from 'multer';
import path from 'path';

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'public/uploads/'); // Lokasi simpan
  },
  filename: (req, file, cb) => {
    // Rename file biar unik: timestamp-namaasli.jpg
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

// Filter hanya gambar
const fileFilter = (req: any, file: any, cb: any) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(new Error('Hanya boleh upload gambar!'), false);
  }
};

export const upload = multer({ 
  storage: storage,
  limits: { fileSize: 2 * 1024 * 1024 }, // Max 2MB
  fileFilter: fileFilter
});
```

---

## 2. Endpoint Upload

### Single File Upload
```ts
import { upload } from './middlewares/upload';

// 'image' adalah nama field di form-data
app.post('/api/products', authenticate, upload.single('image'), async (req, res) => {
  const { name, price } = req.body;
  const file = req.file; // File info ada di sini

  if (!file) return res.status(400).json({ message: "Gambar wajib diupload" });

  // Simpan path gambar ke database
  const product = await prisma.product.create({
    data: {
      name,
      price: Number(price),
      imageUrl: `/uploads/${file.filename}` // Simpan URL relatif
    }
  });

  res.json(product);
});
```
*Jangan lupa update schema `Product` tambah field `imageUrl String?`.*

---

## 3. Menyajikan File Static

Agar gambar bisa diakses browser (misal: `http://localhost:3000/uploads/foto.jpg`), kita perlu set folder `public` sebagai static.

Di `src/index.ts`:
```ts
app.use('/uploads', express.static('public/uploads'));
```

---

## 4. Tugas Harian Hari Ke-15

**Misi:** Produk harus punya gambar!

1.  **Schema:** Tambah kolom `image` (String) di tabel Product.
2.  **Middleware:** Setup Multer untuk simpan ke `public/uploads`.
3.  **Endpoint:** Update POST `/api/products` untuk menerima file gambar.
4.  **Static:** Setup `express.static`.
5.  **Test:**
    - Upload produk via Postman (Body: form-data).
    - Cek folder `public/uploads`, pastikan file masuk.
    - Cek database, pastikan path tersimpan.
    - Buka browser, akses URL gambarnya.

**Checklist:**
- [ ] Bisa upload file gambar.
- [ ] File selain gambar ditolak.
- [ ] Ukuran file > 2MB ditolak.
- [ ] Gambar bisa dilihat di browser.

---

**Tips:** Mengelola file butuh perhatian ekstra pada validasi (tipe & ukuran) agar server tidak penuh sampah. ğŸ–¼ï¸
