# Pekan 3 - Hari 15: Upload File (Direct Upload)

**HARI KE-15** â€“ Menangani Media
**Fokus hari ini:** Mengizinkan user mengupload gambar produk langsung saat membuat produk via `multipart/form-data`.

---

## 1. Konsep

Kita akan mengubah endpoint `Create Product` agar bisa menerima file gambar sekaligus data produk dalam satu request.

**Flow:**
1. Client mengirim request `POST /api/v1/products` dengan tipe konten `multipart/form-data`.
2. Body request berisi:
   - `name`: "Laptop Gaming"
   - `price`: 15000000
   - `image`: [File Gambar]
3. Server memproses upload gambar -> mendapatkan path file.
4. Server menyimpan data produk beserta path gambar ke database.

---

## 2. Persiapan

Install library:
```bash
npm install multer
npm install -D @types/multer
```

Buat folder penyimpanan:
```bash
mkdir -p public/uploads
```

---

## 3. Implementasi Code

### A. Middleware (`src/middlewares/upload.middleware.ts`)
Mengatur konfigurasi multer (lokasi simpan & filter tipe file).

```ts
import multer from 'multer';
import path from 'path';
import { Request } from 'express';

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'public/uploads/');
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
    cb(null, uniqueSuffix + path.extname(file.originalname));
  }
});

const fileFilter = (req: Request, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
  if (file.mimetype.startsWith('image/')) {
    cb(null, true);
  } else {
    cb(null, false);
  }
};

export const upload = multer({ 
  storage: storage,
  limits: { fileSize: 2 * 1024 * 1024 }, // Max 2MB
  fileFilter: fileFilter
});
```

### B. Route (`src/routes/product.route.ts`)
Tambahkan middleware `upload.single('image')` pada route create product.

```ts
import { upload } from '../middlewares/upload.middleware';

// ...
router.post('/products', 
  authenticate, 
  upload.single('image'), // Handle file upload sebelum controller
  validate(createProductValidation), // Validasi body (perlu penyesuaian untuk form-data)
  createProduct
);
```
*Catatan: Validator express-validator mungkin perlu penyesuaian karena `req.body` dari form-data biasanya berupa string semua sebelum diparsing, atau middleware validasi diletakkan setelah multer agar `req.body` sudah terisi.*

### C. Controller (`src/controllers/product.controller.ts`)
Update controller untuk menangani file.

```ts
export const createProduct = asyncHandler(async (req: Request, res: Response) => {
  const file = req.file; // Ambil file dari request
  
  if (!file) {
      return res.status(400).json({ message: "Image is required" });
  }

  // Buat URL relatif untuk disimpan di DB
  const imageUrl = `/public/uploads/${file.filename}`;

  // Gabungkan data body dengan URL gambar
  const productData = {
      ...req.body,
      price: Number(req.body.price), // Konversi manual karena form-data mengirim string
      stock: Number(req.body.stock),
      categoryId: Number(req.body.categoryId),
      image: imageUrl
  };

  const product = await ProductService.createProduct(productData);
  return successResponse(res, 'Produk berhasil ditambahkan', product, null, 201);
});
```

### D. Service (`src/services/product.service.ts`)
Update interface service untuk menerima field `image`.

```ts
export const createProduct = async (data: { 
  name: string; 
  price: number; 
  stock: number;
  description?: string; 
  categoryId: number; 
  image: string; // Tambahan field image
}): Promise<Product> => {
  return await prisma.product.create({
    data: {
      name: data.name,
      description: data.description ?? null,
      price: data.price,
      stock: data.stock,
      categoryId: data.categoryId,
      image: data.image // Simpan ke database
    },
  });
};
```

---

## 4. Tugas Harian

### Misi: Produk dengan Gambar (Direct Upload)

1.  **Schema:** Pastikan tabel `Product` punya kolom `image` (String).
2.  **Middleware:** Setup Multer.
3.  **Endpoint:** Update `POST /api/v1/products` agar menerima `multipart/form-data`.
4.  **Testing:**
    - Gunakan Postman -> Body -> form-data.
    - Key: `name` (Text), `price` (Text), `image` (File).
    - Kirim request dan pastikan produk terbuat dan file tersimpan.

**Checklist:**
- [ ] Bisa upload gambar langsung saat create product.
- [ ] Data produk tersimpan dengan path gambar yang benar.
- [ ] File gambar muncul di folder project.

Selamat coding! ðŸš€
