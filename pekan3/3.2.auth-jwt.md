# Pekan 3 - Hari 14: Auth (JWT & Hashing)

**HARI KE-14** â€“ Keamanan Pintu Masuk
**Fokus hari ini:** Mendaftarkan user dengan aman (Hashing) dan Login (JWT) menggunakan arsitektur Controller-Service.

---

## 1. Konsep Keamanan Dasar

1.  **Jangan simpan password plain text!** (Misal: "rahasia123"). Simpan hash-nya (Misal: "$2b$10$EixZa...").
2.  **Stateless Authentication:** Server tidak menyimpan sesi login. Server memberi "KTP digital" (Token JWT) ke user. User harus bawa KTP itu setiap request.

### Tools
- **bcrypt:** Untuk hash password.
- **jsonwebtoken (JWT):** Untuk membuat token.

```bash
npm install bcrypt jsonwebtoken @types/bcrypt @types/jsonwebtoken
```

---

## 2. Update Schema Database

Kita perlu menambahkan field `password` dan `role` ke tabel users. Sesuaikan file `src/prisma/schema/User.prisma`.

**File:** `src/prisma/schema/User.prisma`

```prisma
model User {
    id Int @id @default(autoincrement())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    deletedAt DateTime? @db.Timestamptz

    name String
    email String @unique
    password String  // <--- Tambahkan ini (hashed)
    role String @default("USER") // <--- Tambahkan ini (USER/ADMIN)
    
    transactions Transaction[]

    @@map("users")
}
```

Jangan lupa jalankan migration untuk update database:

```bash
npx prisma migrate dev --name add_auth_fields
```

---

## 3. Implementasi Auth (Service & Controller)

Kita akan menggunakan pattern **Service** untuk logic dan **Controller** untuk handle request, sesuai struktur project kamu.

### A. Auth Service (Logic)

Buat file baru: `src/services/auth.service.ts`

```ts
import prisma from '../prisma';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import { User } from '../generated/client';

const JWT_SECRET = process.env.JWT_SECRET || 'secret_kunci_rahasia';

export const register = async (data: { name: string; email: string; password: string, role?: string }) => {
  // 1. Cek apakah email sudah terdaftar
  const existingUser = await prisma.user.findUnique({ where: { email: data.email } });
  if (existingUser) {
    throw new Error('Email sudah terdaftar');
  }

  // 2. Hash Password
  const hashedPassword = await bcrypt.hash(data.password, 10);

  // 3. Simpan ke DB
  return await prisma.user.create({
    data: {
      name: data.name,
      email: data.email,
      password: hashedPassword,
      role: data.role || 'USER',
    },
  });
};

export const login = async (data: { email: string; password: string }) => {
  // 1. Cari User
  const user = await prisma.user.findUnique({ where: { email: data.email } });
  if (!user) {
    throw new Error('Email atau Password salah');
  }

  // 2. Cek Password
  const isValid = await bcrypt.compare(data.password, user.password);
  if (!isValid) {
    throw new Error('Email atau Password salah');
  }

  // 3. Generate Token
  const token = jwt.sign(
    { id: user.id, role: user.role }, 
    JWT_SECRET, 
    { expiresIn: '1h' }
  );

  return { user, token };
};
```

### B. Auth Controller (Handler)

Buat file baru: `src/controllers/auth.controller.ts`

```ts
import { Request, Response } from 'express';
import * as AuthService from '../services/auth.service';
import { asyncHandler } from '../utils/async.handler';
import { successResponse } from '../utils/response';

export const register = asyncHandler(async (req: Request, res: Response) => {
  const user = await AuthService.register(req.body);
  // Hindari return password ke client
  const { password, ...userWithoutPassword } = user;
  
  return successResponse(res, 'Register berhasil', userWithoutPassword, null, 201);
});

export const login = asyncHandler(async (req: Request, res: Response) => {
  const result = await AuthService.login(req.body);
  return successResponse(res, 'Login berhasil', result);
});
```

---

## 4. Setup Routing

Buat file route agar endpoint bisa diakses.

### A. Auth Route

Buat file baru: `src/routes/auth.route.ts`

```ts
import { Router } from 'express';
import * as AuthController from '../controllers/auth.controller';

const router = Router();

router.post('/auth/register', AuthController.register);
router.post('/auth/login', AuthController.login);

export default router;
```

### B. Daftarkan Route di App

Edit file `src/app.ts` untuk mendaftarkan route baru.

```ts
// ... imports lainnya
import authRoutes from './routes/auth.route';

// ... setup middleware lainnya

// Routes
// ... route product, category, dll
app.use('/api/v1', authRoutes); // <--- Tambahkan ini
```

---

## 5. Middleware Auth (Proteksi Route)

Middleware ini bertugas mengecek validitas token sebelum user bisa mengakses endpoint tertentu.

### A. Update Type Definition

Agar TypeScript mengenali `req.user`, kita perlu update type definition.
Edit file: `src/types/express.d.ts`

```ts
import { Request } from 'express';

declare global {
  namespace Express {
    interface Request {
      startTime?: number;
      apiKey?: string;
      user?: { // <--- Tambahkan ini
        id: number;
        role: string;
      };
    }
  }
}
```

### B. Buat Middleware

Buat file baru: `src/middlewares/auth.middleware.ts`

```ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'secret_kunci_rahasia';

export const authenticate = (req: Request, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  
  if (!authHeader) {
    return res.status(401).json({ success: false, message: 'Token tidak ditemukan' });
  }

  const token = authHeader.split(' ')[1]; // Format: "Bearer <token>"

  try {
    const payload = jwt.verify(token, JWT_SECRET) as { id: number; role: string };
    
    req.user = payload; // Attach user payload to request
    next();
  } catch (error) {
    return res.status(401).json({ success: false, message: 'Token tidak valid' });
  }
};
```

---

## 6. Contoh Penggunaan Proteksi

Misalnya kita ingin memproteksi endpoint `POST /transactions` (Checkout).

Edit `src/routes/transaction.route.ts`:

```ts
import { Router } from 'express';
import * as TransactionController from '../controllers/transaction.controller';
import { authenticate } from '../middlewares/auth.middleware'; // <--- Import middleware

const router = Router();

// Pasang middleware authenticate sebelum controller
router.post('/transactions', authenticate, TransactionController.createTransaction); 

export default router;
```

Sekarang, saat mengakses endpoint ini, kamu **wajib** mengirim header:
`Authorization: Bearer <token_jwt_dari_login>`

---

## 7. Tugas Harian Ke-14

**Misi:** Amankan API E-Commerce kamu.

1.  **Code:** Implementasikan Register, Login, dan Middleware sesuai panduan di atas.
2.  **Proteksi:**
    - Pasang `authenticate` di endpoint Create Transaction (`POST /transactions`).
    - Pastikan user yang belum login mendapat error 401.
    - (Opsional) Modifikasi `createTransaction` di service agar menggunakan `req.user.id` sebagai `userId` transaksi, bukan dari body request.

**Checklist:**
- [ ] Field password di DB sudah ada dan terenkripsi.
- [ ] Endpoint Login mengembalikan token.
- [ ] Endpoint Checkout (Transaction) tidak bisa diakses tanpa token.
- [ ] Endpoint Checkout bisa diakses dengan token valid.
