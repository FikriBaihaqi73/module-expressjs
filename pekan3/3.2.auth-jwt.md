# Pekan 3 - Hari 14: Auth (JWT & Hashing)

**HARI KE-14** â€“ Keamanan Pintu Masuk
**Fokus hari ini:** Mendaftarkan user dengan aman (Hashing) dan Login (JWT).

---

## 1. Konsep Keamanan Dasar

1.  **Jangan simpan password plain text!** (Misal: "rahasia123"). Kalau database bocor, habis semua. Simpan hash-nya (Misal: "$2b$10$EixZa...").
2.  **Stateless Authentication:** Server tidak menyimpan sesi login. Server memberi "KTP digital" (Token JWT) ke user. User harus bawa KTP itu setiap request.

### Tools
- **bcrypt:** Untuk hash password.
- **jsonwebtoken (JWT):** Untuk membuat token.

```bash
npm install bcrypt jsonwebtoken @types/bcrypt @types/jsonwebtoken
```

---

## 2. Register (Hashing Password)

Update model `User` tambah field `password` dan `role`.

```ts
import bcrypt from 'bcrypt';

app.post('/api/auth/register', async (req, res) => {
  const { name, email, password } = req.body;

  // 1. Hash Password
  const hashedPassword = await bcrypt.hash(password, 10);

  // 2. Simpan ke DB
  const user = await prisma.user.create({
    data: {
      name,
      email,
      password: hashedPassword,
      role: 'USER' // Default role
    }
  });

  res.json({ message: "Register berhasil" });
});
```

---

## 3. Login (Generate JWT)

```ts
import jwt from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'secret_kunci_rahasia';

app.post('/api/auth/login', async (req, res) => {
  const { email, password } = req.body;

  // 1. Cari User
  const user = await prisma.user.findUnique({ where: { email } });
  if (!user) return res.status(401).json({ message: "Email/Password salah" });

  // 2. Cek Password
  const isValid = await bcrypt.compare(password, user.password);
  if (!isValid) return res.status(401).json({ message: "Email/Password salah" });

  // 3. Bikin Token
  const token = jwt.sign({ id: user.id, role: user.role }, JWT_SECRET, { expiresIn: '1h' });

  res.json({ token });
});
```

---

## 4. Middleware Auth (Proteksi Route)

Buat file `src/middlewares/auth.ts`.

```ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';

export interface AuthRequest extends Request {
  user?: any;
}

export const authenticate = (req: AuthRequest, res: Response, next: NextFunction) => {
  const authHeader = req.headers.authorization;
  
  if (!authHeader) return res.status(401).json({ message: "Token tidak ada" });

  const token = authHeader.split(' ')[1]; // "Bearer <token>"

  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET as string);
    req.user = payload; // Simpan data user di request
    next();
  } catch (error) {
    res.status(401).json({ message: "Token tidak valid" });
  }
};
```

### Pakai di Route
```ts
import { authenticate } from './middlewares/auth';

// Hanya user login yang bisa checkout
app.post('/api/checkout', authenticate, async (req, res) => {
  // req.user.id tersedia di sini!
  const userId = (req as any).user.id;
  // ... logic checkout ...
});
```

---

## 5. Tugas Harian Hari Ke-14

**Misi:** Amankan API E-Commerce kamu.

1.  **Register:** Buat endpoint register. Password wajib di-hash.
2.  **Login:** Buat endpoint login. Return JWT token.
3.  **Middleware:** Buat middleware `authenticate`.
4.  **Proteksi:**
    - Pasang middleware di endpoint `/api/checkout` dan `/api/transactions`.
    - Pastikan user yang belum login tidak bisa akses (401 Unauthorized).
    - Pastikan user hanya bisa melihat transaksi miliknya sendiri (Gunakan `req.user.id` di `where`).

**Checklist:**
- [ ] Password di database terenkripsi.
- [ ] Login menghasilkan token panjang.
- [ ] Endpoint terproteksi menolak akses tanpa token.
- [ ] Endpoint terproteksi menerima akses dengan token valid.

---

**Tips:** JWT adalah standar industri. Jaga `JWT_SECRET` di `.env`, jangan di-hardcode! ğŸ”
