# Pekan 3 - Hari 16: Pagination & Query Parameter

**HARI KE-16** â€“ Menangani Data Besar
**Fokus hari ini:** Membuat API yang efisien dengan Pagination, Sorting, dan Filtering menggunakan arsitektur Controller-Service.

---

## 1. Kenapa Pagination?

Kalau produk ada 10.000, `SELECT * FROM products` akan membuat server lambat dan aplikasi klien berat. Kita harus kirim data per halaman (misal 10 per halaman).

---

## 2. Implementasi Pagination di Service

Kita tidak menulis query langsung di `app.get` (route), tapi di **Service**.

Buka `src/services/product.service.ts` dan modifikasi function `getAllProducts` (atau buat function baru `findAll`) agar menerima parameter pagination.

**Rumus Pagination:**
- `take` = limit (jumlah data per halaman)
- `skip` = (page - 1) * limit

```ts
// src/services/product.service.ts
import prisma from '../prisma';
import type { Product } from '../generated/client';

interface FindAllParams {
  page: number;
  limit: number;
  search?: string;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

export const findAllProducts = async (params: FindAllParams) => {
  const { page, limit, search, sortBy, sortOrder } = params;
  
  const skip = (page - 1) * limit;

  // 1. Buat Filter (Where Clause)
  const whereClause: any = {
    deletedAt: null // Selalu filter yang belum dihapus (soft delete)
  };

  if (search) {
    whereClause.name = { contains: search, mode: 'insensitive' };
  }

  // 2. Ambil Data dengan Pagination & Sorting
  const products = await prisma.product.findMany({
    skip: skip,
    take: limit,
    where: whereClause,
    // Gunakan array untuk orderBy agar dinamis
    orderBy: sortBy ? { [sortBy]: sortOrder || 'desc' } : { createdAt: 'desc' },
    include: {
      category: true 
    }
  });

  // 3. Hitung Total Data (untuk metadata pagination)
  const totalItems = await prisma.product.count({
    where: whereClause
  });

  return {
    products,
    totalItems,
    totalPages: Math.ceil(totalItems / limit),
    currentPage: page
  };
};
```

---

## 3. Integrasi di Controller

Sekarang kita update **Controller** untuk mengambil Query Parameters dari request dan memanggil Service.

Buka `src/controllers/product.controller.ts`.

```ts
// src/controllers/product.controller.ts
import type { Request, Response } from 'express';
import * as ProductService from '../services/product.service';
import { asyncHandler } from '../utils/async.handler';
import { successResponse } from '../utils/response';

export const getAllProducts = asyncHandler(async (req: Request, res: Response) => {
  // 1. Ambil Query Params dengan Default Value
  const page = Number(req.query.page) || 1;
  const limit = Number(req.query.limit) || 10;
  const search = req.query.search as string;
  const sortBy = req.query.sortBy as string;
  const sortOrder = (req.query.sortOrder as 'asc' | 'desc') || 'desc';

  // 2. Panggil Service
  const result = await ProductService.findAllProducts({
    page,
    limit,
    search,
    sortBy,
    sortOrder
  });

  // 3. Kirim Response dengan Metadata Pagination
  // Gunakan utility successResponse yang sudah ada di src/utils/response.ts
  const pagination = {
    page: result.currentPage,
    limit: limit,
    total: result.totalItems
  };

  return successResponse(res, 'Daftar produk berhasil diambil', result.products, pagination);
});
```

---

## 4. Tugas Harian Hari Ke-16

**Misi:** Upgrade endpoint `GET /products` di `src/controllers/product.controller.ts` dan `src/services/product.service.ts` menjadi Super Power.

1.  **Refactor Service:** Sesuaikan `product.service.ts` agar menggunakan prisma `skip`, `take`, dan `where` (jangan filter manual pake `.filter()` JS array karena lambat!).
2.  **Refactor Controller:** Update controller agar membaca query params.
3.  **Search:** Pastikan fitur search nama produk berfungsi case-insensitive.
4.  **Sorting:** Tambahkan fitur sorting harga/tanggal.
5.  **Soft Delete:** Pastikan data yang sudah dihapus (`deletedAt` tidak null) tidak ikut muncul.

**Contoh Request:**
`GET /api/products?page=1&limit=5&search=laptop&sortBy=price&sortOrder=asc`

**Checklist:**
- [ ] Pagination berjalan (coba page 1 dan page 2, data harus beda).
- [ ] Search `?search=xyz` berfungsi di database level.
- [ ] Sorting `?sortBy=price` berfungsi.
- [ ] Metadata pagination (page, current, total) muncul di JSON response.

---

**Tips:** Gunakan helper `successResponse` di `src/utils/response.ts` untuk memudahkan format output JSON pagination.
