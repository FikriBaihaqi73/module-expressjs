# Pekan 3 - Hari 13: Relasi Many-to-Many & Eager Loading

**HARI KE-13** â€“ Hubungan yang Kompleks
**Fokus hari ini:** Menangani relasi Banyak-ke-Banyak (N-N) dan mengambil data relasi dengan efisien.

---

## 1. Konsep Many-to-Many (N-N)

Contoh kasus: **Transaksi Belanja**.
- 1 Transaksi bisa berisi BANYAK Produk.
- 1 Produk bisa ada di BANYAK Transaksi.

Di database, kita tidak bisa menyimpan ini secara langsung. Kita butuh **Tabel Penghubung (Pivot Table)**, biasanya bernama `TransactionItems` atau `OrderDetails`.

---

## 2. Implementasi di Prisma

Kita akan buat sistem Checkout sederhana.

### Update Schema (`prisma/schema.prisma`)

```prisma
model User {
  id        Int           @id @default(autoincrement())
  name      String
  transactions Transaction[]
}

model Product {
  id               Int                @id @default(autoincrement())
  name             String
  price            Decimal
  transactionItems TransactionItem[]  // Relasi ke tabel pivot
}

model Transaction {
  id        Int               @id @default(autoincrement())
  userId    Int
  user      User              @relation(fields: [userId], references: [id])
  total     Decimal
  items     TransactionItem[] // Relasi ke tabel pivot
  createdAt DateTime          @default(now())
}

// Tabel Pivot (Penghubung)
model TransactionItem {
  id            Int         @id @default(autoincrement())
  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  productId     Int
  product       Product     @relation(fields: [productId], references: [id])
  quantity      Int
  priceAtTime   Decimal     // Harga saat beli (penting, karena harga produk bisa berubah)
}
```

### Migrasi
```bash
npx prisma migrate dev --name add_transaction_system
```

---

## 3. Transaksi Database (Prisma Transaction)

Saat checkout, kita harus simpan data ke tabel `Transaction` DAN `TransactionItem` sekaligus. Kalau satu gagal, semua harus batal. Gunakan `$transaction`.

```ts
app.post('/api/checkout', async (req, res) => {
  const { userId, items } = req.body; 
  // items format: [{ productId: 1, quantity: 2 }, ...]

  // Hitung total harga dulu (Logic disederhanakan)
  let total = 0;
  // ... logic hitung total ...

  try {
    const result = await prisma.$transaction(async (tx) => {
      // 1. Buat Header Transaksi
      const newTransaction = await tx.transaction.create({
        data: {
          userId,
          total
        }
      });

      // 2. Buat Detail Item
      for (const item of items) {
        await tx.transactionItem.create({
          data: {
            transactionId: newTransaction.id,
            productId: item.productId,
            quantity: item.quantity,
            priceAtTime: 10000 // Ambil dari DB produk aslinya
          }
        });
      }

      return newTransaction;
    });

    res.json(result);
  } catch (error) {
    res.status(500).json({ message: "Checkout gagal" });
  }
});
```

---

## 4. Eager Loading (Include)

Mengambil data transaksi BESERTA detail item dan nama produknya.

```ts
app.get('/api/transactions/:id', async (req, res) => {
  const { id } = req.params;

  const transaction = await prisma.transaction.findUnique({
    where: { id: Number(id) },
    include: {
      user: true, // Ambil data user
      items: {    // Ambil data items
        include: {
          product: true // Di dalam item, ambil data produknya
        }
      }
    }
  });

  res.json(transaction);
});
```
Ini disebut **Eager Loading** (mengambil data relasi di awal).

---

## 5. Tugas Harian Hari Ke-13

**Misi:** Buat fitur Checkout sederhana.

1.  **Schema:** Implementasikan model `User`, `Transaction`, dan `TransactionItem`.
2.  **Seeding:** Buat user dummy dan produk dummy.
3.  **Endpoint Checkout:** Buat POST `/api/checkout`. Terima array `items`. Gunakan `prisma.$transaction`.
4.  **Endpoint History:** Buat GET `/api/transactions` yang menampilkan riwayat belanja user beserta detail barang yang dibeli.

**Checklist:**
- [ ] Schema N-N (via pivot) terbentuk.
- [ ] Transaksi berhasil tersimpan (Header + Detail).
- [ ] Jika error di tengah loop item, transaksi header tidak boleh terbentuk (Atomic).
- [ ] Bisa melihat detail transaksi lengkap dengan nama produk.

---

**Tips:** Transaksi keuangan adalah hal krusial. Pastikan data konsisten dengan `$transaction`. ðŸ’°
