# Pekan 3 - Hari 18: Evaluasi Pekanan: Sistem Manajemen Perpustakaan (Advanced)

**HARI KE-18** ‚Äì Evaluasi & Integrasi Menyeluruh
**Tujuan:** Menggabungkan seluruh materi Pekan 3 (Authentication, Upload, Query Params, Many-to-Many, dan Clean Architecture) ke dalam project **Perpustakaan Digital**.

---

## üéØ Objektif Evaluasi

Melanjutkan project **Perpustakaan** dari evaluasi Pekan 2. Kita akan mengubah aplikasi CRUD sederhana menjadi aplikasi peminjaman buku yang aman, rapi, dan memiliki fitur bisnis yang lengkap.

Evaluasi ini menekankan pada **Security (Auth), Transaksi Kompleks (Peminjaman), dan Kebersihan Kode (Repo Pattern)**.

---

## üìù Instruksi Tugas

Kamu diminta untuk melakukan **Major Upgrade** pada aplikasi backend Perpustakaan kamu.

### 1. Arsitektur & Struktur Kode (Materi Hari 17)
- **Wajib Refactor:** Ubah seluruh kode menjadi **3-Layer Architecture** (Repository - Service - Controller).
- Controller hanya mengurus HTTP (Req/Res).
- Service mengurus Logika Bisnis (Cek stok buku, hitung denda, validasi user).
- Repository mengurus Query Database (Prisma).

### 2. Authentication & Authorization (Materi Hari 14)
- **Register & Login:** User (Member) dan Admin (Pustakawan) bisa login menggunakan **JWT**.
- **Role-Based Access Control (RBAC):**
  - **ADMIN:** Bisa Create/Update/Delete Data Buku & Kategori. Bisa melihat semua history peminjaman.
  - **MEMBER:** Hanya bisa melihat daftar buku, meminjam buku, dan melihat history peminjaman *diri sendiri*.
- **Middleware:** Pasang middleware `verifyToken` dan `adminOnly` pada endpoint yang sesuai.

### 3. Fitur Peminjaman (Materi Hari 13 - Many to Many)
- **Relasi Many-to-Many:**
  - Implementasikan transaksi peminjaman.
  - 1 Peminjaman (`BorrowRecord`) bisa memuat BANYAK Buku (`BorrowItem`).
  - *Skenario:* Member A meminjam "Harry Potter" dan "Lord of the Rings" dalam satu kali transaksi peminjaman.
- **Konsistensi Data ($transaction):**
  - Saat peminjaman terjadi: Stok buku berkurang otomatis.
  - Saat pengembalian: Stok buku bertambah kembali.

### 4. Pencarian & Display (Materi Hari 16)
- Endpoint `GET /books` harus canggih:
  - **Pagination:** `page=1&limit=10`.
  - **Search:** `search=Harry` (Cari judul atau penulis).
  - **Sorting:** `sortBy=title&sortOrder=asc` atau `sortBy=publishedYear&sortOrder=desc`.

### 5. File Upload (Materi Hari 15)
- **Cover Buku:**
  - Saat Admin menambah/edit buku, Admin bisa upload gambar cover buku.
  - File disimpan di folder `public/uploads` atau Cloudinary.
  - URL gambar disimpan di database buku.

---

## üìã Detail Fitur (API Spec)

Berikut adalah *minimum requirement* endpoint utama:

### Auth
1.  `POST /auth/register` - Daftar member baru (default role: MEMBER).
2.  `POST /auth/login` - Login admin/member.

### Books (Public Read, Admin Write)
3.  `GET /books` - Pagination + Search + Sort (Semua orang bisa akses).
4.  `POST /books` - (Admin) Upload cover + Simpan data buku.
5.  `PUT /books/:id` - (Admin) Update.
6.  `DELETE /books/:id` - (Admin) Soft delete.

### Borrowing (Transaksi Peminjaman)
7.  `POST /borrow` - (Member) Pinjam buku.
    - Body: `[{ bookId: 1, qty: 1 }, { bookId: 5, qty: 1 }]`
    - Logic: Cek stok cukup? Cek Member valid? Kurangi stok, Buat record.
8.  `POST /return` - (Admin/Member) Mengembalikan buku.
    - Logic: Update status jadi "Returned", kembalikan stok.
9.  `GET /my-borrowings` - (Member) Lihat riwayat peminjaman sendiri.

---

## üíØ Kriteria Penilaian (Total: 100 Poin)

| Kategori | Bobot | Detail Penilaian |
| :--- | :---: | :--- |
| **Architecture** | **30** | ‚Ä¢ Struktur **Repository-Service-Controller** diterapkan dengan benar dan konsisten (15)<br>‚Ä¢ Kode logic tidak bocor ke Controller (15) |
| **Security (Auth)** | **20** | ‚Ä¢ Login & Register JWT Berjalan (10)<br>‚Ä¢ Admin bisa CRUD Buku, Member TIDAK BISA (Middleware jalan) (10) |
| **Database & Logic** | **25** | ‚Ä¢ Relasi Many-to-Many (Peminjaman - Buku) benar (10)<br>‚Ä¢ **Stok Logic:** Stok berkurang saat dipinjam, bertambah saat kembali (10)<br>‚Ä¢ Pagination Search (5) |
| **Fitur Tambahan** | **15** | ‚Ä¢ Upload Cover Buku berhasil (10)<br>‚Ä¢ Validasi Input (Zod/Joi) lengkap (5) |
| **Dokumentasi** | **10** | ‚Ä¢ Postman Collection Rapi & Lengkap (10) |

---

## üöÄ Langkah Pengerjaan
1.  **Refactor:** Pindahkan kode CRUD Buku Pekan 2 ke struktur Repository baru.
2.  **Auth:** Tambahkan tabel `User` (field: email, password, role) dan fitur Login.
3.  **Upgrade DB:** Tambahkan tabel `Borrow` dan `BorrowItem`. Update relasi di `schema.prisma`.
4.  **Fitur Peminjaman:** Buat Service Peminjaman dng logic transaksi stok.
5.  **Finalisasi:** Tambahkan upload gambar dan pagination.

**Deadline: Minggu Pukul 23:59 WIB**
Selamat menuntaskan modul Backend lanjut ini! üìöüî•
