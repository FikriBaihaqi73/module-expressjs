# Pekan 4 - Hari 22: Testing API (Jest + Supertest)

**HARI KE-22** – Menguji Sebelum Merilis
**Fokus hari ini:** Membuat Automated Test untuk memastikan API berjalan sesuai harapan.

---

## 1. Kenapa Testing?

Supaya kalau kita ubah kode di masa depan, kita bisa tahu kalau ada fitur lama yang rusak (Regression).

### Tools
- **Jest:** Test Runner.
- **Supertest:** Simulasi HTTP Request ke Express.

### Install
```bash
npm install jest supertest ts-jest @types/jest @types/supertest @types/jsonwebtoken --save-dev
npx ts-jest config:init
```

Jangan lupa update `package.json` agar command `npm test` bisa jalan:

```json
"scripts": {
  "test": "jest"
}
```

---

## 2. Menulis Test

Karena API kita dilindungi oleh Auth Middleware, kita perlu membuat token palsu di dalam test agar bisa menembus endpoint.

Buat file `src/tests/product.test.ts`.

```ts
import request from 'supertest';
import app from '../app'; // Import dari src/app.ts
import jwt from 'jsonwebtoken';

describe('GET /api/v1/products', () => {
  // Buat token dummy untuk testing
  const token = jwt.sign({ id: 1, role: 'USER' }, process.env.JWT_SECRET || 'secret_kunci_rahasia');

  it('should return 401 if no token provided', async () => {
    const res = await request(app).get('/api/v1/products');
    
    expect(res.statusCode).toEqual(401);
    expect(res.body.success).toBe(false);
  });

  it('should return 200 and list of products', async () => {
    const res = await request(app)
      .get('/api/v1/products')
      .set('Authorization', `Bearer ${token}`); // Lampirkan token
    
    expect(res.statusCode).toEqual(200);
    expect(res.body.success).toBe(true);
    expect(Array.isArray(res.body.data)).toBe(true);
  });
});
```

*Catatan: Pastikan `src/index.ts` hanya menjalankan `app.listen`, sedangkan `src/app.ts` hanya melakukan export `app`.*

---

## 3. Menjalankan Test

Untuk menjalankan test yang sudah dibuat, gunakan perintah berikut di terminal:

```bash
npm test
```

Jika berhasil, Jest akan menampilkan laporan seperti ini:

```
 PASS  src/tests/product.test.ts
  GET /api/v1/products
    ✓ should return 401 if no token provided (15 ms)
    ✓ should return 200 and list of products (20 ms)

Test Suites: 1 passed, 1 total
Tests:       2 passed, 2 total
Snapshots:   0 total
Time:        1.234 s
Ran all test suites.
```

---

## 4. Tugas Harian Hari Ke-22

**Misi:** Buat test untuk 1 flow CRUD Produk.

1.  **Preparation:** Install package dan init jest config.
2.  **Test GET:** Pastikan return 200 (Success) dan 401 (Unauthorized).
3.  **Test POST (Create):**
    - Kirim data valid + Token -> Expect 201.
    - Kirim data tanpa Token -> Expect 401.
4.  **Run:** Jalankan `npm test`.

**Checklist:**
- [ ] `npm test` menampilkan centang hijau (PASS).
- [ ] Minimal 2 endpoint di-test (GET & POST).

---

**Tips:** "Green-Red-Refactor". Test yang baik membuat kita tidur nyenyak saat deploy ke production. ✅
