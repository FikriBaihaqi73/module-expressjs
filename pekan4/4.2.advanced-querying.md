# Pekan 4 - Hari 20: Advanced Querying (Prisma)

**HARI KE-20** – Analisis Data dan Query Kompleks
**Fokus hari ini:** Mengimplementasikan query tingkat lanjut menggunakan Prisma di dalam arsitektur **Repository, Service, dan Controller** yang sudah kita bangun.

---

## 1. Filter Kompleks (AND, OR) pada Repository

Dalam arsitektur kita, logika query Prisma selalu ditempatkan di dalam **Repository**. Berikut contoh penambahan metode pencarian kompleks di `src/repositories/product.repository.ts`.

```ts
// src/repositories/product.repository.ts
export class ProductRepository {
  // ... metode lainnya ...

  async findComplex(categoryName: string, maxPrice: number) {
    return await prisma.product.findMany({
      where: {
        OR: [
          {
            AND: [
              { category: { name: categoryName } },
              { price: { lt: maxPrice } }
            ]
          },
          { category: { name: 'Aksesoris' } }
        ]
      }
    });
  }
}
```

## 2. Aggregation (Count, Sum, Avg, Min, Max)

Aggregation digunakan untuk mendapatkan statistik data langsung dari database. Sangat efisien untuk data berjumlah besar.

```ts
// src/repositories/product.repository.ts
export class ProductRepository {
  async getStatistics() {
    return await prisma.product.aggregate({
      _count: { id: true },      // Total jumlah produk
      _avg: { price: true },     // Rata-rata harga
      _sum: { stock: true },     // Total stok semua barang
      _min: { price: true },     // Harga termurah
      _max: { price: true }      // Harga termahal
    });
  }
}
```

## 3. Group By

Group By memungkinkan kita mengelompokkan data berdasarkan field tertentu, misalnya menghitung jumlah produk per kategori.

```ts
// src/repositories/product.repository.ts
export class ProductRepository {
  async getProductsByCategoryStats() {
    return await prisma.product.groupBy({
      by: ['categoryId'],
      _count: { id: true },
      _avg: { price: true }
    });
  }
}
```

---

## 4. Implementasi pada Service & Controller

Sesuai dengan pattern individual service class yang kita gunakan di `src/services/product.service.ts`:

### Service Layer
```ts
// src/services/product.service.ts
export class getProductStatsService {
  constructor(private productRepo: ProductRepository) { }

  async execute() {
    const stats = await this.productRepo.getStatistics();
    const categoryStats = await this.productRepo.getProductsByCategoryStats();
    
    return {
      overview: stats,
      byCategory: categoryStats
    };
  }
}
```

### Controller Layer
```ts
// src/controllers/product.controller.ts
export class ProductController {
  // ... constructor dengan injection ...

  getStats = asyncHandler(async (req: Request, res: Response) => {
    const stats = await this.getProductStatsSvc.execute();
    return successResponse(res, 'Statistik produk berhasil diambil', stats);
  });
}
```

---

## 5. Tugas Harian Hari Ke-20

**Misi:** Buat endpoint Dashboard Statistik yang menggabungkan data dari berbagai repository.

1.  **Endpoint:** `GET /api/products/stats`.
2.  **Kebutuhan Data:**
    - Total jumlah produk.
    - Total stok seluruh produk.
    - Daftar 5 produk dengan stok paling menipis (stok < 10).
    - Rata-rata harga produk per kategori.
3.  **Langkah Kerja:**
    - Tambahkan metode yang diperlukan di `ProductRepository`.
    - Buat Service class baru `getProductDashboardService`.
    - Daftarkan di `ProductController` dan `product.route.ts`.

**Checklist:**
- [ ] Implementasi menggunakan Repository Pattern.
- [ ] Menggunakan fitur `aggregate` atau `groupBy` Prisma.
- [ ] Response format menggunakan `successResponse` utility.

---

**Tips:** Jangan lakukan perhitungan statistik di dalam loop JavaScript (`forEach`/`map`) jika data Anda ribuan. Biarkan Database yang bekerja menggunakan Aggregation/Group By! ⚡
